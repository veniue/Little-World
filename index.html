<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/wTHv885Z/IMG-1403.jpg">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Miyo小世界</title>
    <style>
        :root {
            --bg-color: #000000;
            --text-color: #ffffff;
            --btn-bg: #ffffff;
            --btn-text: #000000;
            --gray-text: #888888;
            --grid-gap: 25px;
            --btn-height: 85px;
            --btn-radius: 18px;
            --danger-color: #ff4d4d;
            --edit-color: #4d94ff;
            --pin-color: #ff9500;
            --item-bg: #1a1a1a;
            --input-bg: #333;
            --border-color: #444;
            --msg-user-bg: #444444;
            --msg-user-text: #ffffff;
            --msg-char-bg: #444444; 
            --msg-char-text: #ffffff;
            --toolbar-height: 240px;
            --nav-top-padding: 15px;
            --chat-bg-image: none;
            
            /* 新增：用于日夜切换的专用变量 */
            --nav-bg-start: rgba(0,0,0,1);  /* 导航栏渐变起始 */
            --nav-bg-end: rgba(0,0,0,0);    /* 导航栏渐变结束 */
            --modal-bg: #1a1a1a;            /* 弹窗背景 */
            --modal-border: #333;           /* 弹窗边框 */
            --icon-color: #ffffff;          /* 图标颜色 */
            --footer-bg: #000000;           /* 底部栏背景 */
        }

        /* ==================== 日间模式全反色变量 ==================== */
        [data-theme="light"] {
            /* 基础颜色 */
            --bg-color: #f2f2f7;      /* 背景：浅灰 */
            --text-color: #000000;    /* 文字：黑 */
            --gray-text: #666666;     /* 辅助文字：深灰 */
            
            /* 按钮 */
            --btn-bg: #ffffff;        /* 按钮背景：白 (原黑变白) */
            --btn-text: #000000;      /* 按钮文字：黑 */
            
            /* 列表项与卡片 */
            --item-bg: #ffffff;       /* 列表项背景：纯白 */
            --border-color: #d1d1d6;  /* 边框：浅灰 */
            
            /* 输入框 */
            --input-bg: #e5e5ea;      /* 输入框背景：浅灰 */
            
            /* 聊天气泡 */
            --msg-user-bg: #95ec69;   /* 用户气泡：绿色 */
            --msg-user-text: #000000; /* 用户气泡文字：黑 */
            --msg-char-bg: #ffffff;   /* 角色气泡：白 */
            --msg-char-text: #000000; /* 角色气泡文字：黑 */
            
            /* 导航与工具栏 */
            --nav-bg-start: rgba(242,242,247,1); /* 导航栏：浅灰不透明 */
            --nav-bg-end: rgba(242,242,247,0);   /* 导航栏：浅灰透明 */
            --footer-bg: #f2f2f7;                /* 底部栏：浅灰 */
            --toolbar-bg: #ffffff;               /* 工具栏面板背景：白 */
            
            /* 图标与特殊元素 */
            --icon-color: #000000;               /* 图标：黑 */
            --modal-bg: #ffffff;                 /* 弹窗：纯白 */
            --modal-border: #d1d1d6;             /* 弹窗边框：浅灰 */
            
            /* 特殊按钮 (拉取模型、重置背景等) */
            --pull-btn-bg: #e5e5ea;              /* 灰色按钮背景 */
            --pull-btn-text: #000000;            /* 灰色按钮文字 */
        }

        /* 日间模式下的特殊元素调整 */
        [data-theme="light"] .desktop-icon {
            background-color: #ffffff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        [data-theme="light"] .desktop-label {
            color: #000000;
            text-shadow: none; /* 日间模式去掉文字阴影 */
        }
        [data-theme="light"] #real-time-clock {
            color: #000000;
            text-shadow: none;
        }
        [data-theme="light"] .form-input, 
        [data-theme="light"] .form-textarea,
        [data-theme="light"] .chat-input {
            color: #000000;
        }
        [data-theme="light"] .nav-title,
        [data-theme="light"] .modal-title {
            color: #000000;
        }

        /* ==================== 日间模式组件样式覆盖 ==================== */

        /* 1. 工具栏面板 (背景变白，文字变黑) */
        [data-theme="light"] .toolbar-panel {
            background-color: var(--toolbar-bg);
            border-top: 1px solid var(--border-color);
            color: var(--text-color);
        }
        [data-theme="light"] #toolbar-multiselect {
            background-color: var(--toolbar-bg);
            border-top: 1px solid var(--border-color);
        }

        /* 2. 工具栏图标与文字 */
        [data-theme="light"] .toolbar-item {
            color: var(--gray-text); /* 文字深灰 */
        }
        [data-theme="light"] .toolbar-item:active {
            color: #000; /* 点击变黑 */
        }
        [data-theme="light"] .toolbar-icon {
            background-color: #f2f2f7; /* 图标背景浅灰 */
            color: #000; /* 图标黑色 */
        }

        /* 3. 表情包/语音/照片/转账面板 */
        [data-theme="light"] .emoji-btn-small {
            background-color: #e5e5ea; /* 按钮浅灰 */
            color: #000;
        }
        [data-theme="light"] .emoji-item {
            background-color: #f2f2f7; /* 表情占位浅灰 */
            border: 1px solid #e5e5ea;
        }
        [data-theme="light"] .photo-preview-area {
            background-color: #f2f2f7;
            border: 1px solid #d1d1d6;
            color: #666;
        }
        [data-theme="light"] .transfer-footer {
            background-color: #e5e5ea;
            color: #666;
        }

        /* 4. 输入框 (通用) */
        [data-theme="light"] .chat-input,
        [data-theme="light"] .form-input,
        [data-theme="light"] .form-textarea,
        [data-theme="light"] .emoji-textarea,
        [data-theme="light"] .voice-textarea,
        [data-theme="light"] .photo-textarea,
        [data-theme="light"] .transfer-input,
        [data-theme="light"] .jailbreak-input {
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }
        /* 输入框占位符颜色 */
        [data-theme="light"] ::placeholder {
            color: #999;
        }

        /* 5. 列表项文字颜色 (世界书、人物设定、预设列表) */
        [data-theme="light"] .wb-title,
        [data-theme="light"] .info-name,
        [data-theme="light"] .preset-name,
        [data-theme="light"] .more-name-text {
            color: #000000; /* 标题变黑 */
        }
        [data-theme="light"] .wb-preview,
        [data-theme="light"] .info-desc,
        [data-theme="light"] .preset-url,
        [data-theme="light"] .summary-text-preview,
        [data-theme="light"] .summary-date {
            color: #666666; /* 预览内容变深灰 */
        }
        [data-theme="light"] .wb-category-header,
        [data-theme="light"] .api-section-title {
            color: #666666;
        }

        /* 6. 特殊按钮 (拉取模型、重置背景、手动总结等) */
        [data-theme="light"] .btn-pull {
            background-color: var(--pull-btn-bg);
            color: var(--pull-btn-text);
            border: 1px solid var(--border-color);
        }
        [data-theme="light"] .btn-pull:active {
            background-color: #d1d1d6;
        }

        /* 7. 主设置滑动条 (轨道变浅灰) */
        [data-theme="light"] input[type=range]::-webkit-slider-runnable-track {
            background-color: transparent; 
            border: 1px solid #d1d1d6; /* 浅色边框 */
        }
        [data-theme="light"] input[type=range]::-webkit-slider-thumb {
            background: #000; /* 滑块变黑 */
        }

        /* 8. 默认头像占位符 */
        [data-theme="light"] .avatar,
        [data-theme="light"] .chat-msg-avatar,
        [data-theme="light"] .more-avatar,
        [data-theme="light"] .transfer-detail-avatar {
            background-color: #e5e5ea; /* 浅灰底色 */
            border: 1px solid #d1d1d6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none; /* iOS禁止长按默认菜单 */
            user-select: none; /* 禁止选择文本，由自定义菜单接管 */
        }

        body {
            background-color: var(--bg-color);
            font-family: "Microsoft YaHei", "Heiti SC", sans-serif;
            color: var(--text-color);
            overflow-x: hidden;
        }

        /* ==================== 通用页面结构 ==================== */
        .page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-color);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 10;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            pointer-events: none;
        }

        .page.active { 
            transform: translateX(0); 
            pointer-events: auto;
        }

        /* 欢迎页专用样式 */
        #welcome-page {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        
        #main-page {
            position: relative;
            transform: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            /* 修改：改为两端对齐，以便放置顶部的时钟和底部的图标 */
            justify-content: space-between; 
            min-height: 100vh;
            width: 100%;
            z-index: 1;
            /* 新增：桌面背景支持 */
            background-image: var(--desktop-bg-image, none);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            /* 新增：上下边距 */
            padding-top: 100px;
            padding-bottom: 80px;
        }

        /* ==================== 新增：桌面时钟与图标样式 ==================== */
        
        /* 实时时钟 */
        #real-time-clock {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: white;
            text-shadow: 0 2px 8px rgba(0,0,0,0.6); /* 增加阴影以适应浅色背景 */
            z-index: 2;
        }
        .clock-time {
            font-size: 72px;
            font-weight: 300;
            line-height: 1;
            font-family: sans-serif;
            letter-spacing: -2px;
        }
        .clock-date {
            font-size: 18px;
            margin-top: 10px;
            font-weight: 500;
            opacity: 0.9;
        }

        /* 桌面图标网格 */
        .desktop-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 一行三个 */
            gap: 30px 20px; /* 行间距30px，列间距20px */
            width: 100%;
            max-width: 340px;
            padding: 0 10px;
            z-index: 2;
        }

        .desktop-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: transform 0.1s;
            -webkit-tap-highlight-color: transparent;
        }
        .desktop-item:active {
            transform: scale(0.9);
            opacity: 0.8;
        }

        .desktop-icon {
            width: 62px;
            height: 62px;
            background-color: rgba(255, 255, 255, 0.95); /* 纯白背景，微透 */
            border-radius: 16px; /* iOS风格圆角 */
            margin-bottom: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            /* 图标图片支持 */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            /* 默认图标占位 (可选) */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #333;
        }

        .desktop-label {
            font-size: 13px;
            color: white;
            text-shadow: 0 1px 4px rgba(0,0,0,0.8); /* 确保文字在任何背景下可见 */
            text-align: center;
            font-weight: 500;
            white-space: nowrap;
        }

        .container {
            width: 100%;
            max-width: 380px;
            padding: 30px;
            text-align: center;
        }

        h1 { font-size: 28px; font-weight: normal; margin-bottom: 20px; letter-spacing: 1px; }
        .subtitle { color: var(--gray-text); font-size: 18px; margin-bottom: 60px; }

        .button-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--grid-gap);
            width: 100%;
        }

        .btn {
            background-color: var(--btn-bg);
            color: var(--btn-text);
            width: 100%;
            height: var(--btn-height);
            border-radius: var(--btn-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            border: none;
            cursor: pointer;
            text-decoration: none;
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.96); background-color: #f2f2f2; }

        /* ==================== 导航栏 ==================== */
        .nav-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--nav-top-padding) 20px 15px 20px; /* 使用变量控制顶部距离 */
            height: auto; /* 高度改为自适应 */
            min-height: 60px;
            background: linear-gradient(to bottom, var(--nav-bg-start) 0%, var(--nav-bg-end) 100%);
            position: sticky;
            top: 0;
            z-index: 20;
            flex-shrink: 0;
        }

        .nav-btn {
            background: none;
            border: none;
            color: var(--icon-color); /* 使用变量 */
            font-size: 24px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-title { font-size: 20px; font-weight: bold; }

        /* ==================== 列表内容区域 ==================== */
        .list-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: 80px; 
            min-height: 60vh; 
        }

        /* 列表项样式 (iOS 修复版) */
        .list-item-wrapper {
            position: relative;
            margin-bottom: 15px;
            min-height: 80px;
            border-radius: 12px; 
            overflow: hidden;    
            background-color: var(--item-bg); 
            transform: translateZ(0); 
            z-index: 0;
        }

        .list-item-actions {
            position: absolute;
            top: 0;
            right: 0;
            height: 100%;
            width: 140px; 
            display: flex;
            z-index: 1; 
        }

        .action-btn {
            flex: 1;
            border: none;
            color: white;
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .btn-edit { background-color: var(--edit-color); }
        .btn-delete { background-color: var(--danger-color); }
        .btn-pin { background-color: var(--pin-color); }

        .list-item {
            position: relative;
            background-color: var(--item-bg);
            width: 100%;
            height: 100%; 
            min-height: 80px;
            padding: 15px;
            display: flex;
            align-items: center;
            z-index: 2; 
            transition: transform 0.2s ease-out;
            border-radius: 0; 
        }

        .avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #333;
            margin-right: 15px;
            object-fit: cover;
            flex-shrink: 0;
        }

        .info {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .info-name { font-size: 18px; font-weight: bold; margin-bottom: 6px; }
        .info-desc {
            font-size: 14px;
            color: #888;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: all 0.3s;
            padding-right: 5px;
        }

        .list-item.expanded { align-items: flex-start; }
        .list-item.expanded .info-desc {
            white-space: pre-wrap; 
            word-break: break-word;
            line-height: 1.6;
            margin-top: 5px;
            color: #aaa;
        }

        /* ==================== API 设置 & 更多设置 界面样式 ==================== */
        .api-content, .settings-content {
            padding: 20px;
            display: flex;
            flex-direction: column;
            min-height: calc(100vh - 60px);
        }

        .api-section-title {
            color: var(--gray-text);
            font-size: 14px;
            margin-bottom: 10px;
            margin-top: 25px;
            padding-left: 5px;
        }
        
        .input-group { margin-bottom: 20px; }

        .input-label {
            display: block;
            color: #888;
            font-size: 14px;
            margin-bottom: 8px;
            padding-left: 5px;
        }

        .form-input {
            width: 100%;
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            color: white;
            padding: 12px;
            border-radius: 10px;
            font-size: 16px;
            outline: none;
        }

        select.form-input {
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23FFFFFF%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right 15px top 50%;
            background-size: 12px auto;
        }

        .jailbreak-input {
            width: 100%;
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            color: white;
            padding: 12px;
            border-radius: 10px;
            font-size: 16px;
            outline: none;
            resize: none;
            height: 100px;
            line-height: 1.5;
        }

        .btn-pull {
            width: 100%;
            background-color: #333;
            color: #ccc;
            border: 1px solid #444;
            border-radius: 10px;
            padding: 10px;
            font-size: 14px;
            margin-top: 8px;
            cursor: pointer;
        }
        .btn-pull:active { background-color: #444; color: #fff; }
        .btn-pull:disabled { opacity: 0.6; cursor: not-allowed; }

        .btn-save-api, .btn-block {
            width: 100%;
            background-color: white;
            color: black;
            font-weight: bold;
            padding: 14px;
            border-radius: 12px;
            border: none;
            font-size: 16px;
            margin-top: 10px;
            margin-bottom: 10px;
            cursor: pointer;
        }
        .btn-save-api:active, .btn-block:active { opacity: 0.8; }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        /* 预设列表样式 (iOS 修复版) */
        .preset-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 40px;
        }

        .preset-wrapper {
            position: relative;
            border-radius: 12px; 
            overflow: hidden;    
            background-color: var(--item-bg); 
            transform: translateZ(0); 
            z-index: 0;
        }

        .preset-delete-btn {
            position: absolute;
            top: 0;
            right: 0;
            height: 100%;
            width: 80px;
            background-color: var(--danger-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            z-index: 1;
            cursor: pointer;
        }

        .preset-item {
            background-color: var(--item-bg);
            padding: 15px;
            border-radius: 0; 
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            border: none;
            position: relative;
            z-index: 2; 
            transition: transform 0.2s ease-out;
            width: 100%;
            height: 100%;
        }
        .preset-item:active { background-color: #222; }
        
        .preset-info { display: flex; flex-direction: column; }
        .preset-name { font-weight: bold; font-size: 16px; color: white; margin-bottom: 4px; }
        .preset-url { font-size: 12px; color: #666; }
        .preset-select-icon { color: #444; }

        /* ==================== 欢迎页样式 (里世界) ==================== */
        .welcome-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 30px;
            width: 100%;
        }

        .welcome-text {
            font-size: 22px;
            line-height: 1.6;
            color: white;
            animation: fadeIn 0.5s ease;
            cursor: pointer;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .welcome-btns {
            display: flex;
            gap: 20px;
            margin-top: 30px;
        }

        .btn-welcome {
            background-color: white;
            color: black;
            padding: 10px 30px;
            border-radius: 10px;
            font-weight: bold;
            border: none;
            font-size: 16px;
            cursor: pointer;
        }
        .btn-welcome:active { opacity: 0.8; }

        /* ==================== 主设置界面样式 ==================== */
        .btn-clear-data {
            width: 100%;
            background-color: var(--danger-color);
            color: white;
            font-weight: bold;
            padding: 14px;
            border-radius: 12px;
            border: none;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
        }
        .btn-clear-data:active { opacity: 0.8; }

        /* ==================== 聊天界面样式 ==================== */
        .chat-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            /* 确保背景色覆盖底部安全区域 */
            background: var(--footer-bg); /* 使用变量以适配日夜模式 */
            /* 增加底部内边距适配全面屏 */
            padding: 10px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            display: flex;
            align-items: flex-end;
            gap: 10px;
            /* 必须有边框或渐变，这里使用之前的渐变逻辑，但要覆盖到底 */
            z-index: 20;
            transition: bottom 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); /* 添加过渡动画 */
        }
        
        /* 修复日夜模式下的渐变背景，确保延伸到底部 */
        .chat-footer {
             background: linear-gradient(to top, var(--nav-bg-start) 0%, var(--nav-bg-end) 100%);
             background-color: var(--footer-bg); /* 兜底背景色 */
        }

        .chat-footer.toolbar-open {
            bottom: var(--toolbar-height);
        }

        .chat-input {
            flex: 1;
            background-color: #222;
            border: none;
            border-radius: 20px;
            padding: 10px 15px;
            color: white;
            font-size: 16px;
            outline: none;
            resize: none; /* 禁止手动拖动 */
            height: 40px; /* 默认单行高度 */
            overflow: hidden;
            line-height: 20px; /* 确保文字垂直居中 */
            transition: height 0.2s;
        }
        
        /* 展开状态样式 */
        .chat-input.expanded {
            height: 120px; /* 展开后的高度 */
            overflow-y: auto;
            border-radius: 15px;
        }

        .chat-btn {
            background: none;
            border: none;
            color: var(--icon-color); /* 使用变量 */
            padding: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .chat-btn:active { opacity: 0.7; }

        /* 多选底部栏 (新增) */
        #toolbar-multiselect {
            display: none;
            justify-content: space-between;
            padding: 15px 30px;
            background-color: var(--footer-bg); /* 使用变量 */
            border-top: 1px solid var(--border-color);
            z-index: 21;
        }
        #toolbar-multiselect.show { display: flex; }
        .multiselect-btn {
            background: none;
            border: none;
            color: var(--text-color); /* 使用变量 */
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
        .multiselect-btn.delete { color: var(--danger-color); }

        /* 工具栏面板 */
        .toolbar-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: var(--toolbar-height);
            background-color: #111;
            display: flex; 
            flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            z-index: 19;
            border-top: 1px solid #222;
        }
        .toolbar-panel.open {
            transform: translateY(0);
        }

        /* 主工具栏网格 */
        #toolbar-main {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 15px;
            padding: 20px;
            width: 100%;
            height: 100%;
        }

        /* 表情包面板 */
        #toolbar-emoji, #toolbar-voice, #toolbar-photo, #toolbar-transfer {
            display: none;
            flex-direction: column;
            width: 100%;
            height: 100%;
            padding: 10px;
        }
        
        .emoji-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }

        /* 语音/照片/转账栏横线移到上方 */
        .voice-actions, .photo-actions, .transfer-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #333;
            border-bottom: none;
        }
        
        .emoji-btn-small {
            flex: 1;
            background-color: #333;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px;
            font-size: 12px;
            cursor: pointer;
        }
        .emoji-btn-small:active { opacity: 0.7; }
        .emoji-btn-small.delete-mode { background-color: var(--danger-color); }

        .emoji-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            overflow-y: auto;
        }
        
        .emoji-item {
            width: 100%;
            aspect-ratio: 1;
            background-color: #222;
            border-radius: 8px;
            object-fit: cover;
            cursor: pointer;
            position: relative;
        }
        .emoji-item.deleting { opacity: 0.5; border: 2px solid var(--danger-color); }

        /* 添加表情包面板 */
        .emoji-add-panel {
            display: none;
            flex-direction: column;
            height: 100%;
            padding: 10px;
        }
        .emoji-textarea, .voice-textarea, .photo-textarea, .transfer-input {
            flex: 1;
            background: #222;
            color: white;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 10px;
            resize: none;
            margin-bottom: 10px;
            font-size: 14px;
            line-height: 1.5;
        }
        .voice-textarea { height: 100%; margin-bottom: 0; }
        
        /* 照片栏样式 */
        .photo-preview-area {
            height: 100px;
            background-color: #222;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 1px solid #444;
        }
        .photo-preview-img {
            height: 100%;
            width: auto;
            object-fit: contain;
        }
        .photo-preview-placeholder {
            color: #666;
            font-size: 12px;
        }

        /* 转账栏样式 - 底部对齐 */
        #toolbar-transfer {
            justify-content: flex-start;
        }
        .transfer-input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex: none;
            width: 80%;
            margin: 0 auto;
            margin-top: 20px;
        }
        .transfer-input {
            height: 40px;
            margin-bottom: 0;
            flex: none;
        }
        .transfer-actions {
            margin-top: auto; 
        }

        .toolbar-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #aaa;
            font-size: 12px;
            cursor: pointer;
        }
        .toolbar-item:active { color: white; }
        .toolbar-icon {
            width: 40px;
            height: 40px;
            background-color: #333;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 5px;
            color: white;
        }
        .toolbar-icon svg { width: 24px; height: 24px; }


        /* 聊天气泡 & 头像样式 */
        .chat-msg-row {
            display: flex;
            margin-bottom: 15px;
            width: 100%;
            align-items: flex-start; /* 顶部对齐 */
            gap: 10px;
            position: relative; /* 用于长按菜单定位 */
        }
        .chat-msg-row.user {
            justify-content: flex-end;
        }
        .chat-msg-row.char {
            justify-content: flex-start;
        }

        .chat-msg-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
            background-color: #333;
        }

        /* 消息内容包裹层 (用于包含气泡和引用) */
        .msg-content-wrapper {
            display: flex;
            flex-direction: column;
            max-width: 70%;
        }
        .chat-msg-row.user .msg-content-wrapper { align-items: flex-end; }
        .chat-msg-row.char .msg-content-wrapper { align-items: flex-start; }

        /* 气泡基础样式 */
        .chat-bubble {
            position: relative; 
            padding: 8px 12px; 
            border-radius: 8px; 
            font-size: 15px; 
            line-height: 1.5;
            word-wrap: break-word;
            max-width: 100%; 
            
            /* 核心修改：彻底禁止系统长按菜单 */
            user-select: none; 
            -webkit-user-select: none;
            -webkit-touch-callout: none !important; /* iOS 关键 */
            -webkit-user-drag: none;
        }

        /* 统一系统消息样式 (时间、撤回、引用) */
        .chat-system-time span,
        .sys-recall-msg span {
            background-color: rgba(255, 255, 255, 0.15); /* 统一半透明背景 */
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            color: #ccc;
            display: inline-block;
            max-width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* 气泡内部引用样式 (新增) */
        .internal-quote {
            background-color: rgba(0, 0, 0, 0.2); /* 深色背景增加对比度 */
            border-left: 3px solid #888;
            padding: 4px 8px;
            margin-bottom: 6px;
            border-radius: 4px;
            font-size: 12px;
            color: #ccc;
            display: flex;
            flex-direction: column;
            text-align: left; /* 始终左对齐 */
            max-width: 100%;
            white-space: pre-wrap; /* 保留换行 */
        }
        .internal-quote-name {
            font-weight: bold;
            margin-bottom: 2px;
            color: #fff;
        }
        .internal-quote-content {
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3; /* 限制显示3行，解决引用太长的问题 */
            -webkit-box-orient: vertical;
        }

        /* 撤回消息样式 */
        .sys-recall-msg {
            width: 100%;
            text-align: center;
            margin: 10px 0;
            cursor: pointer;
            display: flex;
            justify-content: center;
        }

        /* 系统时间消息样式 */
        .chat-system-time {
            width: 100%;
            text-align: center;
            margin: 15px 0;
            display: flex;
            justify-content: center;
        }

        /* 图片消息样式 - 修改：缩小一点 */
        .chat-image {
            max-width: 100px;
            border-radius: 8px;
            display: block;
        }

        /* 语音气泡样式 */
        .voice-bubble-container {
            display: flex;
            flex-direction: column;
            min-width: 100px;
            cursor: pointer;
        }
        .voice-header {
            display: flex;
            align-items: flex-end; /* 底部对齐 */
            gap: 8px;
        }
        .voice-icon {
            width: 20px; height: 20px;
            display: flex; align-items: center; justify-content: center;
            margin-bottom: 2px;
        }
        .voice-wave {
            display: flex;
            align-items: flex-end; /* 竖条底部对齐 */
            gap: 2px;
            height: 20px;
        }
        .voice-bar {
            width: 3px;
            background-color: currentColor;
            border-radius: 2px;
            transition: height 0.1s ease;
            transform-origin: bottom; /* 修改：确保底部固定，顶部浮动 */
        }
        /* 从左往右下降 */
        .voice-bar:nth-child(1) { height: 16px; }
        .voice-bar:nth-child(2) { height: 13px; }
        .voice-bar:nth-child(3) { height: 10px; }
        .voice-bar:nth-child(4) { height: 7px; }
        .voice-bar:nth-child(5) { height: 4px; }
        
        /* 语音播放动画 */
        @keyframes voiceWave {
            0% { transform: scaleY(1); }
            50% { transform: scaleY(1.5); }
            100% { transform: scaleY(1); }
        }
        .voice-bubble-container.playing .voice-bar {
            animation: voiceWave 0.8s infinite ease-in-out;
        }
        .voice-bubble-container.playing .voice-bar:nth-child(1) { animation-delay: 0.1s; }
        .voice-bubble-container.playing .voice-bar:nth-child(2) { animation-delay: 0.2s; }
        .voice-bubble-container.playing .voice-bar:nth-child(3) { animation-delay: 0.3s; }
        .voice-bubble-container.playing .voice-bar:nth-child(4) { animation-delay: 0.2s; }
        .voice-bubble-container.playing .voice-bar:nth-child(5) { animation-delay: 0.1s; }
        
        .voice-seconds {
            font-size: 14px;
            line-height: 1.2;
            margin-bottom: 2px;
        }
        .voice-text {
            display: none;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255,255,255,0.2);
            font-size: 14px;
            white-space: pre-wrap;
            text-align: left;
        }
        .voice-text.show { display: block; }
        [data-theme="light"] .voice-text {
            border-top: 1px solid rgba(0,0,0,0.1); /* 分割线变浅黑 */
        }

        /* 用户气泡特定样式 (竖条在秒数右侧) */
        .chat-bubble.user .voice-header {
            flex-direction: row;
            justify-content: flex-end;
        }
        .chat-bubble.user .voice-seconds { order: 1; margin-right: 5px; }
        .chat-bubble.user .voice-wave { order: 2; }
        .chat-bubble.user .voice-icon { display: none; } /* 用户隐藏图标 */

        /* 角色气泡特定样式 (竖条在左侧，递增) */
        .chat-bubble.char .voice-header {
            flex-direction: row;
            justify-content: flex-start;
        }
        .chat-bubble.char .voice-icon { display: none; } /* 角色也隐藏图标，保持简洁 */
        .chat-bubble.char .voice-wave { order: 1; }
        .chat-bubble.char .voice-seconds { order: 2; margin-left: 5px; }
        
        /* 角色竖条从左往右递增 */
        .chat-bubble.char .voice-bar:nth-child(1) { height: 4px; }
        .chat-bubble.char .voice-bar:nth-child(2) { height: 7px; }
        .chat-bubble.char .voice-bar:nth-child(3) { height: 10px; }
        .chat-bubble.char .voice-bar:nth-child(4) { height: 13px; }
        .chat-bubble.char .voice-bar:nth-child(5) { height: 16px; }

        /* 照片信息气泡样式 */
        .photo-info-bubble {
            width: 120px;
            min-height: 100px;
            height: auto;
            background-color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #aaa;
            font-size: 12px;
            border-radius: 8px;
            cursor: pointer;
            padding: 10px;
        }
        .photo-text-desc {
            display: none;
            margin-top: 8px;
            font-size: 12px;
            color: #ccc;
            white-space: pre-wrap;
            text-align: center;
            width: 100%;
            border-top: 1px solid rgba(255,255,255,0.1);
            padding-top: 5px;
        }
        .photo-text-desc.show { display: block; }
        [data-theme="light"] .photo-info-bubble {
            background-color: #ffffff;
            border: 1px solid #d1d1d6;
            color: #000000;
        }
        [data-theme="light"] .photo-text-desc {
            color: #666666;
            border-top: 1px solid #e5e5ea;
        }

        /* 转账气泡样式 */
        .transfer-bubble {
            width: 230px;
            background-color: #444; /* 灰色背景 */
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            cursor: pointer;
        }
        .transfer-content {
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .transfer-icon-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .transfer-icon-circle svg { width: 20px; height: 20px; color: white; }
        .transfer-info {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .transfer-amount {
            font-size: 16px;
            color: white;
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .transfer-remark {
            font-size: 12px;
            color: #ccc;
            margin-top: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .transfer-footer {
            background-color: #555;
            padding: 5px 15px;
            font-size: 12px;
            color: #aaa;
        }

        /* 转账详情弹窗样式 */
        .transfer-detail-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            padding-top: 10px;
        }
        .transfer-detail-avatar {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            margin-bottom: 10px;
            background-color: #333;
        }
        .transfer-detail-name {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .transfer-detail-status {
            font-size: 14px;
            color: #aaa;
            margin-bottom: 20px;
        }
        .transfer-detail-amount {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 20px;
        }
        .transfer-detail-meta {
            width: 100%;
            text-align: left;
            font-size: 14px;
            color: #888;
            border-top: 1px solid #333;
            padding-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .meta-row { display: flex; justify-content: space-between; }
        [data-theme="light"] .transfer-bubble {
            background-color: #ffffff; /* 日间变白 */
            border: 1px solid #d1d1d6; /* 加个边框 */
        }
        [data-theme="light"] .transfer-amount {
            color: #000000; /* 金额变黑 */
        }
        [data-theme="light"] .transfer-remark {
            color: #666666; /* 备注变灰 */
        }
        [data-theme="light"] .transfer-icon-circle {
            border-color: #000000; /* 图标圈变黑 */
        }
        [data-theme="light"] .transfer-icon-circle svg {
            color: #000000; /* 图标变黑 */
        }


        /* 用户气泡 (右侧) */
        .chat-bubble.user {
            background-color: var(--msg-user-bg);
            color: var(--msg-user-text);
            margin-right: 8px; 
        }
        /* 用户气泡小三角 */
        .chat-bubble.user::after {
            content: '';
            position: absolute;
            top: 14px; 
            right: -6px;
            width: 0;
            height: 0;
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
            border-left: 6px solid var(--msg-user-bg);
        }
        /* 图片/转账消息不需要背景和小三角 */
        .chat-bubble.has-image {
            background-color: transparent !important;
            padding: 0;
        }
        .chat-bubble.has-image::after {
            display: none;
        }

        /* 角色气泡 (左侧) - 必须是白色 */
        .chat-bubble.char {
            background-color: var(--msg-char-bg);
            color: var(--msg-char-text);
            margin-left: 8px; 
        }
        /* 角色气泡小三角 - 适配白色 */
        .chat-bubble.char::after {
            content: '';
            position: absolute;
            top: 14px;
            left: -6px;
            width: 0;
            height: 0;
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
            border-right: 6px solid var(--msg-char-bg);
        }
        
        /* 修改：聊天记录容器样式，支持被工具栏顶起，移除 transition 以消除缓冲 */
        #chat-messages {
            transition: none;
        }
        #chat-messages.shifted {
            padding-bottom: calc(80px + var(--toolbar-height));
        }

/* 长按菜单样式 (新增) */
.context-menu {
    position: fixed;
    background-color: #222;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    z-index: 1000;
    display: none;
    flex-direction: column;
    width: 120px;
    overflow: hidden;
}
.context-menu.show { display: flex; }
.context-menu-item {
    padding: 12px 15px;
    color: white;
    font-size: 14px;
    border-bottom: 1px solid #333;
    text-align: center;
    cursor: pointer;
}
.context-menu-item:last-child { border-bottom: none; }
.context-menu-item:active { background-color: #333; }
/* 移除红色，继承父级颜色 */
.context-menu-item.danger { color: inherit; }

/* 日间模式下的长按菜单样式 */
[data-theme="light"] .context-menu {
    background-color: #ffffff;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    border: 1px solid #d1d1d6;
}
[data-theme="light"] .context-menu-item {
    color: #000000;
    border-bottom: 1px solid #e5e5ea;
}
[data-theme="light"] .context-menu-item:active {
    background-color: #f2f2f7;
}

        /* 更多设置界面头像 (新布局) */
        .more-profile-row {
            display: flex;
            align-items: center;
            width: 100%;
            background-color: var(--item-bg);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
        }
        .more-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #444;
            margin-right: 15px;
            flex-shrink: 0;
        }
        .more-name-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            cursor: pointer;
        }
        .more-role-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 4px;
        }
        .more-name-text {
            font-size: 18px;
            font-weight: bold;
            color: white;
            display: flex;
            align-items: center;
        }
        /* 名字后面的小图标提示可点击 */
        .more-name-text::after {
            content: '';
            display: inline-block;
            width: 6px;
            height: 6px;
            border-right: 2px solid #666;
            border-bottom: 2px solid #666;
            transform: rotate(-45deg);
            margin-left: 8px;
        }
        [data-theme="light"] .more-role-label {
            color: #666666;
        }
        [data-theme="light"] .more-name-text::after {
            border-color: #000000; /* 箭头变黑 */
        }

        /* 总结列表样式 */
        #summary-list-container {
            width: 100%;
            margin-top: 10px;
        }
        .summary-content-wrapper {
            background-color: var(--item-bg);
            padding: 15px;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
            z-index: 2;
            transition: transform 0.2s ease-out;
        }
        .summary-text-preview {
            font-size: 14px;
            color: #ccc;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .summary-content-wrapper.expanded .summary-text-preview {
            white-space: pre-wrap;
            color: #fff;
        }
        .summary-date {
            font-size: 12px;
            color: #888;
            margin-bottom: 4px;
        }

        /* ==================== 世界书样式 (新增) ==================== */
        .wb-category-header {
            width: 100%;
            padding: 10px 5px;
            font-size: 14px;
            color: #888;
            font-weight: bold;
            margin-top: 10px;
            text-align: left;
        }
        
        /* 统一使用 list-item-wrapper 结构以支持左滑 */
        .wb-item-content {
            background-color: var(--item-bg);
            padding: 15px;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
            z-index: 2;
            transition: transform 0.2s ease-out;
        }
        .wb-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
            color: white;
        }
        .wb-preview {
            font-size: 14px;
            color: #aaa;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .wb-item-content.expanded .wb-preview {
            white-space: pre-wrap;
        }

        /* 分类选择器容器 */
        .category-input-wrapper {
            position: relative;
            width: 100%;
        }
        .category-select-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #888;
            cursor: pointer;
            padding: 5px;
        }
        
        /* 简单的分类选择下拉框 */
        #category-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background-color: #222;
            border: 1px solid #444;
            border-radius: 8px;
            z-index: 100;
            display: none;
            max-height: 150px;
            overflow-y: auto;
        }
        #category-dropdown.show { display: block; }
        .category-option {
            padding: 10px 15px;
            color: white;
            cursor: pointer;
            text-align: left;
            border-bottom: 1px solid #333;
        }
        .category-option:last-child { border-bottom: none; }
        .category-option:hover { background-color: #333; }

        /* 世界书选择弹窗 (用于绑定) */
        .wb-select-list {
            width: 100%;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }
        .wb-select-item {
            background-color: #333;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            text-align: left;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .wb-select-item.selected {
            background-color: #fff;
            color: #000;
            font-weight: bold;
        }
        .wb-select-item:active { opacity: 0.8; }


        /* ==================== 弹窗样式 ==================== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .modal-overlay.show { opacity: 1; pointer-events: auto; }

        .modal {
            background-color: var(--modal-bg) !important; /* 强制覆盖内联样式 */
            border: 1px solid var(--modal-border);
            color: var(--text-color);
            width: 85%;
            max-width: 320px;
            border-radius: 20px;
            padding: 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
            max-height: 80vh; /* 防止内容过长溢出屏幕 */
        }

        .modal-title { 
            font-size: 20px; 
            font-weight: bold; 
            margin-bottom: 25px; 
            color: var(--text-color); /* 确保标题颜色跟随主题 */
        }

        .avatar-upload {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: #1a1a1a;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            overflow: hidden;
            border: 2px solid #555;
            position: relative;
            transition: border-color 0.3s;
        }
        .avatar-upload:active { border-color: #fff; }
        .avatar-upload img { width: 100%; height: 100%; object-fit: cover; display: none; z-index: 2; }
        .avatar-icon { color: #555; z-index: 1; }

        .form-textarea {
            width: 100%;
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            color: white;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 25px;
            font-size: 16px;
            outline: none;
            resize: none;
            height: 100px;
            line-height: 1.5;
        }

        /* 查看详情弹窗的内容样式 */
        #view-details-content {
            width: 100%;
            text-align: left;
            white-space: pre-wrap; /* 保留换行 */
            color: #ccc;
            font-size: 15px;
            line-height: 1.6;
            overflow-y: auto;
            max-height: 300px; /* 内容滚动 */
            margin-bottom: 20px;
        }

        .modal-btns { display: flex; width: 100%; gap: 15px; }
        .modal-btn { flex: 1; padding: 12px; border-radius: 10px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; }
        .btn-cancel { background-color: #333; color: #fff; }
        .btn-save { background-color: #fff; color: #000; opacity: 0.5; pointer-events: none; transition: opacity 0.3s; }
        .btn-save.active { opacity: 1; pointer-events: auto; }

#chat-interface-page {
    /* 添加背景图支持 */
    background-image: var(--chat-bg-image);
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
}

        /* ==================== 新增样式 ==================== */

        /* 1. 主设置滑动条样式 (灰色) */
        input[type=range] {
            -webkit-appearance: none; /* 去除默认样式 */
            width: 100%;
            background: transparent;
        }
        /* 滑块 (Thumb) */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #888; /* 灰色滑块 */
            cursor: pointer;
            margin-top: -8px; /* 垂直居中 */
        }
        /* 轨道 (Track) */
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: transparent; /* 修改：透明背景 */
            border-radius: 2px;
        }

        /* 2. 多选模式下系统消息的选中样式 */
        /* 撤回消息被选中 */
        .sys-recall-msg.selected span {
            background-color: #4d94ff !important; /* 选中变蓝 */
            color: white !important;
        }
        /* 时间消息被选中 */
        .chat-system-time.selected span {
            background-color: #4d94ff !important; /* 选中变蓝 */
            color: white !important;
        }
        /* 气泡被选中 (增强原有样式) */
        .chat-bubble.selected {
            filter: brightness(1.2); /* 稍微变亮 */
            box-shadow: 0 0 0 2px #4d94ff; /* 蓝色边框指示 */
        }

        /* ==================== 日间模式细节修正 ==================== */

        /* 1. 主设置滑动条 (日间模式) */
        [data-theme="light"] input[type=range]::-webkit-slider-runnable-track {
            background: transparent;
            height: 4px;
        }
        [data-theme="light"] input[type=range]::-webkit-slider-thumb {
            background: #333; /* 滑块颜色 */
            margin-top: -9px; /* 修正对齐 */
        }

        /* ==================== 日间模式文字颜色修复 ==================== */

        /* 1. 列表展开后的内容颜色 (人物设定、更多界面) */
        /* 强制变为深色，与世界书一致 */
        [data-theme="light"] .list-item.expanded .info-desc,
        [data-theme="light"] .summary-content-wrapper.expanded .summary-text-preview {
            color: #333333 !important; /* 深灰色，清晰可见 */
        }

        /* 2. 查看详情弹窗的内容颜色 */
        [data-theme="light"] #view-details-content {
            color: #333333 !important; /* 深灰色 */
        }

        /* 3. 更多界面 - 设定预览文字 */
        /* 确保更多界面里的名字下方的预览文字（如果有）也变色 */
        [data-theme="light"] .more-role-label {
            color: #666666; /* 标签保持灰色 */
        }
        [data-theme="light"] .more-name-text {
            color: #000000; /* 名字纯黑 */
        }

        /* 4. 修复滑动条在日间模式下的边框和轨道 */
        [data-theme="light"] input[type=range] {
            border: 1px solid #d1d1d6; /* 浅灰边框 */
        }

        /* 3. 默认头像背景色 (日间模式) */
        /* 强制覆盖 JS 中 onerror 设置的内联 background-color */
        [data-theme="light"] .avatar,
        [data-theme="light"] .chat-msg-avatar,
        [data-theme="light"] .more-avatar,
        [data-theme="light"] .transfer-detail-avatar {
            background-color: #e5e5ea !important; /* 浅灰背景 */
            border: 1px solid #d1d1d6;
        }

        /* ==================== 日间模式细节修复：分割线与点击态 ==================== */

        /* 1. 修复工具栏面板内的分割线 (表情/语音/照片/转账) */
        [data-theme="light"] .emoji-actions {
            border-bottom: 1px solid #d1d1d6; /* 浅灰分割线 */
        }
        
        [data-theme="light"] .voice-actions, 
        [data-theme="light"] .photo-actions, 
        [data-theme="light"] .transfer-actions {
            border-top: 1px solid #d1d1d6; /* 浅灰分割线 */
        }

        /* 2. 修复配置预设列表的点击/滑动颜色 */
        /* 原代码是 background-color: #222; 日间模式需要改为浅灰 */
        [data-theme="light"] .preset-item:active {
            background-color: #e5e5ea; 
        }

        /* 3. 顺便修复一下照片预览区域的边框 (如果有) */
        [data-theme="light"] .photo-preview-area {
            border: 1px solid #d1d1d6;
        }

        /* ==================== 日间模式细节修复：头像上传占位符 ==================== */

        /* 1. 修复上传圆圈的背景和边框 (变浅灰) */
        [data-theme="light"] .avatar-upload {
            background-color: #e5e5ea; /* 浅灰背景 */
            border: 2px solid #d1d1d6; /* 浅灰边框 */
        }

        /* 2. 修复中间的人像图标颜色 (变深灰) */
        [data-theme="light"] .avatar-icon {
            color: #999999; /* 图标颜色加深，确保可见 */
        }

        /* 3. 修复点击时的边框高亮颜色 */
        [data-theme="light"] .avatar-upload:active {
            border-color: #666666;
        }

        /* ==================== 日间模式细节修复：下拉框与列表项 ==================== */

        /* 1. 绑定世界书列表项 */
        [data-theme="light"] .wb-select-item {
            background-color: #e5e5ea; /* 浅灰背景 */
            color: #000000; /* 黑字 */
            border: 1px solid #d1d1d6; /* 浅灰边框 */
        }
        /* 选中状态 */
        [data-theme="light"] .wb-select-item.selected {
            background-color: #000000; /* 选中变黑 */
            color: #ffffff; /* 选中文字变白 */
            border-color: #000000;
        }

        /* 2. 世界书分类下拉框容器 */
        [data-theme="light"] #category-dropdown {
            background-color: #ffffff; /* 纯白背景 */
            border: 1px solid #d1d1d6;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); /* 柔和阴影 */
        }

        /* 3. 分类下拉选项 */
        [data-theme="light"] .category-option {
            color: #000000; /* 黑字 */
            border-bottom: 1px solid #e5e5ea;
        }
        [data-theme="light"] .category-option:hover {
            background-color: #f2f2f7; /* 悬停浅灰 */
        }

        /* 4. 世界书列表分组展开后的内容颜色 */
        /* 强制覆盖展开后的文字颜色 */
        [data-theme="light"] .wb-item-content.expanded .wb-preview {
            color: #333333 !important; /* 深灰，清晰可见 */
        }

        /* 强制覆盖聊天容器样式 (修复版) */
        #chat-messages {
            display: block !important;
            /* 动态计算高度：视口 - (顶部内容高+顶部内边距) - (底部栏高+安全区域) */
            height: auto !important; 
            overflow-y: scroll !important;
            position: absolute;
            /* 1. 修复顶部联动：基础高度45px + 动态内边距 */
            top: calc(45px + var(--nav-top-padding)) !important;
            left: 0;
            width: 100%;
            padding-bottom: 20px;
            z-index: 1;
            /* 2. 修复底部适配：基础高度60px + 底部安全区域 */
            bottom: calc(60px + env(safe-area-inset-bottom)) !important;
        }
        
        /* 适配工具栏打开状态 */
        #chat-messages.shifted {
            bottom: calc(60px + var(--toolbar-height)) !important;
            height: auto !important;
        }

        /* ==================== 最终修复：消除工具栏间隙 ==================== */

        /* 1. 聊天记录容器 (工具栏打开时) */
        #chat-messages.shifted {
            /* 核心修改：bottom 只计算工具栏高度+安全区域 */
            /* 这样容器会一直延伸到输入框的底部，消除了中间的空隙 */
            bottom: calc(var(--toolbar-height) + env(safe-area-inset-bottom)) !important;
            
            /* 核心修改：通过增加内边距，防止最后一条消息被输入框遮挡 */
            /* 80px 大约是输入框的高度 */
            padding-bottom: 80px !important; 
        }

        /* 2. 输入框/底部栏 (工具栏打开时) */
        .chat-footer.toolbar-open {
            /* 紧贴工具栏顶部 */
            bottom: calc(var(--toolbar-height) + env(safe-area-inset-bottom)) !important;
            /* 确保层级高于聊天记录 */
            z-index: 20;
        }

        /* 3. 确保底部栏背景在日间/夜间模式下都不透明，防止看到后面延伸的消息 */
        .chat-footer {
            /* 使用纯色背景覆盖，避免半透明导致内容重叠 */
            background: var(--footer-bg) !important; 
            /* 如果想要渐变效果且不透底，需要两层背景，这里为了稳妥建议用纯色 */
        }

        /* ==================== 绝对强制修复：工具栏遮挡问题 ==================== */

        /* 1. 基础状态 (高优先级) */
        body #chat-messages {
            /* 强制定位 */
            position: absolute !important;
            top: calc(45px + var(--nav-top-padding)) !important;
            left: 0 !important;
            width: 100% !important;
            
            /* 强制铺满到底部 */
            bottom: 0 !important;
            height: auto !important;
            
            /* 强制内边距：输入框高度(80px) + 安全区域 */
            padding-bottom: calc(80px + env(safe-area-inset-bottom)) !important;
            
            overflow-y: scroll !important;
            z-index: 1 !important;
            transition: padding-bottom 0.2s ease-out !important;
        }

        /* 2. 工具栏打开状态 (极高优先级) */
        body #chat-messages.shifted {
            /* 强制内边距：工具栏(240px) + 输入框(80px) + 缓冲(60px) = 380px */
            /* 这个数值非常大，绝对能把内容顶上去 */
            padding-bottom: calc(80px + env(safe-area-inset-bottom)) !important;
        }

        /* 3. 底部栏位置与背景修复 (高优先级) */
        body .chat-footer {
            position: fixed !important;
            bottom: 0 !important;
            z-index: 999 !important;
            transition: bottom 0.2s ease-out !important;
            
            /* 核心修复：恢复透明渐变背景 */
            /* 使用变量 var(--nav-bg-start/end) 来适配日夜模式 */
            /* 夜间：黑色->透明；日间：浅灰->透明 */
            background: linear-gradient(to top, var(--nav-bg-start) 0%, var(--nav-bg-end) 100%) !important;
            
            /* 移除可能存在的纯色背景 */
            background-color: transparent !important;
            border-top: none !important;
        }

        /* 4. 底部栏打开状态 (高优先级) */
        body .chat-footer.toolbar-open {
            /* 上移工具栏高度 */
            bottom: var(--toolbar-height) !important;
        }

    </style>
</head>
<body>

    <!-- 主界面 (重构版) -->
    <div id="main-page">
        <!-- 顶部时钟 -->
        <div id="real-time-clock">
            <div class="clock-time" id="clock-time">00:00</div>
            <div class="clock-date" id="clock-date">1月1日 星期一</div>
        </div>

        <!-- 底部图标区域 (3个一行) -->
        <div class="desktop-grid">
            <!-- 1. 里世界 -->
            <div class="desktop-item" onclick="openInnerWorld()">
                <div class="desktop-icon" id="icon-inner"></div>
                <div class="desktop-label">里世界</div>
            </div>
            <!-- 2. 人物设定 -->
            <div class="desktop-item" onclick="openSettings()">
                <div class="desktop-icon" id="icon-char"></div>
                <div class="desktop-label">人物设定</div>
            </div>
            <!-- 3. 世界书 -->
            <div class="desktop-item" onclick="openWorldbook()">
                <div class="desktop-icon" id="icon-wb"></div>
                <div class="desktop-label">世界书</div>
            </div>
            <!-- 4. 外世界 (原飞行棋) - 已调换位置 -->
            <div class="desktop-item">
                <div class="desktop-icon" id="icon-outer"></div>
                <div class="desktop-label">外世界</div>
            </div>
            <!-- 5. API设置 - 已调换位置 -->
            <div class="desktop-item" onclick="openApiSettings()">
                <div class="desktop-icon" id="icon-api"></div>
                <div class="desktop-label">API设置</div>
            </div>
            <!-- 6. 主设置 -->
            <div class="desktop-item" onclick="openMainSettings()">
                <div class="desktop-icon" id="icon-main"></div>
                <div class="desktop-label">主设置</div>
            </div>
        </div>
    </div>

    <!-- 里世界欢迎界面 -->
    <div id="welcome-page" class="page" onclick="handleWelcomeClick()">
        <div class="welcome-content">
            <div id="welcome-text-container" class="welcome-text">
                大人，欢迎来到里世界
            </div>
            <div id="welcome-btn-container" class="welcome-btns" style="display: none;">
                <button class="btn-welcome" onclick="checkApiAndEnter(event)">已配置</button>
                <button class="btn-welcome" onclick="goToApiFromWelcome(event)">去配置</button>
            </div>
        </div>
    </div>

    <!-- 聊天列表界面 -->
    <div id="chat-list-page" class="page">
        <div class="nav-bar">
            <button class="nav-btn" onclick="closeChatList()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </button>
            <div class="nav-title">里世界</div>
            <button class="nav-btn" onclick="openChatSetup()">
                <!-- 加号 -->
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            </button>
        </div>
        <div class="list-content" id="chat-list-container">
            <div style="text-align: center; color: #555; margin-top: 50px;">暂无会话</div>
        </div>
    </div>

    <!-- 聊天界面 -->
    <div id="chat-interface-page" class="page">
        <div class="nav-bar">
            <button class="nav-btn" onclick="closeChatInterface()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </button>
            <div class="nav-title" id="chat-title">角色名</div>
            <button class="nav-btn" onclick="openChatMore()">
                <!-- 更多 (三点) -->
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg>
            </button>
        </div>
        <!-- 修改：添加点击事件以关闭工具栏 -->
        <div class="list-content" id="chat-messages" onclick="closeToolbar(); hideContextMenu();">
            <!-- 聊天记录区域 -->
        </div>
        
<div class="chat-footer" id="chat-footer">
    <!-- 工具栏按钮 (圆圈加号) -->
    <button class="chat-btn" onclick="toggleToolbar()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
    </button>
    <!-- 修改为 textarea 并添加双击事件，删除了 placeholder -->
    <textarea class="chat-input" id="chat-input-box" onclick="closeToolbar()" ondblclick="toggleInputExpand()"></textarea>
    <!-- 新增：取消引用按钮 -->
    <button class="chat-btn" id="cancel-quote-btn" style="display: none;" onclick="cancelQuote()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
    </button>
    <!-- 接收按钮 -->
    <button class="chat-btn" onclick="triggerReceive()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
    </button>
    <!-- 发送按钮 -->
    <button class="chat-btn" onclick="sendMessage()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
    </button>
</div>

        <!-- 多选底部栏 -->
        <div id="toolbar-multiselect" class="chat-footer" style="display: none; justify-content: space-between;">
            <button class="multiselect-btn" onclick="cancelMultiSelect()">取消</button>
            <button class="multiselect-btn delete" onclick="deleteSelectedMessages()">删除</button>
        </div>

        <!-- 长按菜单 -->
        <div id="context-menu" class="context-menu">
            <!-- JS填充 -->
        </div>

        <!-- 撤回内容查看弹窗 -->
        <div class="modal-overlay" id="recall-view-overlay" onclick="if(event.target===this) document.getElementById('recall-view-overlay').classList.remove('show')">
            <div class="modal">
                <div class="modal-title">已撤回消息</div>
                <div id="recall-view-content" style="width:100%; text-align:left; white-space:pre-wrap; color:#ccc; max-height:300px; overflow-y:auto;"></div>
                <div class="modal-btns" style="margin-top:20px;">
                    <button class="modal-btn" style="background-color: white; color: black;" onclick="document.getElementById('recall-view-overlay').classList.remove('show')">关闭</button>
                </div>
            </div>
        </div>

        <!-- 工具栏面板 -->
        <div class="toolbar-panel" id="chat-toolbar">
            <!-- 主工具栏网格 -->
            <div id="toolbar-main">
                <div class="toolbar-item" onclick="toolbarAction('regenerate')">
                    <div class="toolbar-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
                    </div>
                    <span>重回</span>
                </div>
                <div class="toolbar-item" onclick="toolbarAction('continue')">
                    <div class="toolbar-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                    </div>
                    <span>继续</span>
                </div>
                <div class="toolbar-item" onclick="toolbarAction('emoji')">
                    <div class="toolbar-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 2 4 2 4-2 4-2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></svg>
                    </div>
                    <span>表情包</span>
                </div>
                <div class="toolbar-item" onclick="toolbarAction('voice')">
                    <div class="toolbar-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
                    </div>
                    <span>语音</span>
                </div>
                <div class="toolbar-item" onclick="toolbarAction('photo')">
                    <div class="toolbar-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                    </div>
                    <span>照片</span>
                </div>
                <div class="toolbar-item" onclick="toolbarAction('transfer')">
                    <div class="toolbar-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
                    </div>
                    <span>转账</span>
                </div>
                <div class="toolbar-item" onclick="toolbarAction('call')">
                    <div class="toolbar-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
                    </div>
                    <span>语音通话</span>
                </div>
                <div class="toolbar-item" onclick="toolbarAction('video')">
                    <div class="toolbar-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg>
                    </div>
                    <span>视频通话</span>
                </div>
            </div>

            <!-- 表情包面板 -->
            <div id="toolbar-emoji">
                <!-- 表情包列表视图 -->
                <div id="emoji-view-list" style="display:flex; flex-direction:column; height:100%;">
                    <div class="emoji-actions">
                        <button class="emoji-btn-small" onclick="openAddEmojiPanel()">添加URL</button>
                        <button class="emoji-btn-small" onclick="document.getElementById('emoji-upload-input').click()">上传本地</button>
                        <button class="emoji-btn-small" id="emoji-delete-toggle" onclick="toggleDeleteEmoji()">删除模式: 关</button>
                        <button class="emoji-btn-small" onclick="closeEmojiPanel()">返回</button>
                    </div>
                    <div class="emoji-grid" id="emoji-grid-container">
                        <!-- JS 填充 -->
                    </div>
                </div>

                <!-- 添加表情包视图 -->
                <div id="emoji-view-add" class="emoji-add-panel">
                    <textarea id="emoji-add-input" class="emoji-textarea" placeholder="格式提示：&#10;文字描述：URL链接&#10;文字描述:URL链接&#10;文字描述 URL链接&#10;例如：开心:https://example.com/happy.jpg"></textarea>
                    <div style="display:flex; gap:10px;">
                        <button class="emoji-btn-small" onclick="saveAddedEmojis()">添加</button>
                        <button class="emoji-btn-small" onclick="cancelAddEmoji()">取消</button>
                    </div>
                </div>
                
                <input type="file" id="emoji-upload-input" accept="image/*" style="display: none;" onchange="uploadEmoji(event)">
            </div>

            <!-- 语音面板 -->
            <div id="toolbar-voice">
                <textarea id="voice-input" class="voice-textarea" placeholder="输入语音内容..."></textarea>
                <div class="voice-actions">
                    <button class="emoji-btn-small" onclick="sendVoice()">发送</button>
                    <button class="emoji-btn-small" onclick="closeVoicePanel()">返回</button>
                </div>
            </div>

            <!-- 照片面板 -->
            <div id="toolbar-photo">
                <textarea id="photo-input" class="photo-textarea" placeholder="输入照片内容描述..."></textarea>
                <div class="photo-preview-area" id="photo-preview-area">
                    <span class="photo-preview-placeholder">本地上传预览</span>
                </div>
                <div class="photo-actions">
                    <button class="emoji-btn-small" onclick="document.getElementById('photo-upload-input').click()">本地上传</button>
                    <button class="emoji-btn-small" onclick="sendPhoto()">发送</button>
                    <button class="emoji-btn-small" onclick="closePhotoPanel()">返回</button>
                </div>
                <input type="file" id="photo-upload-input" accept="image/*" style="display: none;" onchange="previewPhoto(event)">
            </div>

            <!-- 转账面板 -->
            <div id="toolbar-transfer">
                <div class="transfer-input-group">
                    <input type="number" id="transfer-amount" class="transfer-input" placeholder="转账金额">
                    <input type="text" id="transfer-remark" class="transfer-input" placeholder="备注 (选填)">
                </div>
                <div class="transfer-actions">
                    <button class="emoji-btn-small" onclick="sendTransfer()">转账</button>
                    <button class="emoji-btn-small" onclick="closeTransferPanel()">返回</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 转账详情弹窗 -->
    <div class="modal-overlay" id="transfer-detail-overlay" onclick="if(event.target===this) document.getElementById('transfer-detail-overlay').classList.remove('show')">
        <div class="modal" style="max-width: 300px;">
            <div id="transfer-detail-content" class="transfer-detail-content">
                <!-- JS 填充 -->
            </div>
            <div class="modal-btns" style="margin-top: 20px;" id="transfer-detail-btns">
                <button class="modal-btn" style="background-color: white; color: black; border: 1px solid #ddd;" onclick="document.getElementById('transfer-detail-overlay').classList.remove('show')">关闭</button>
            </div>
        </div>
    </div>

    <!-- 更多设置界面 (布局更新) -->
    <div id="chat-more-page" class="page">
        <div class="nav-bar">
            <button class="nav-btn" onclick="closeChatMore()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </button>
            <div class="nav-title">更多</div>
            <div class="nav-btn"></div>
        </div>
        <div class="settings-content">
            <!-- 隐藏的文件输入 -->
            <input type="file" id="more-char-avatar-input" accept="image/*" style="display: none;" onchange="handleMoreAvatarChange(event, 'char')">
            <input type="file" id="more-user-avatar-input" accept="image/*" style="display: none;" onchange="handleMoreAvatarChange(event, 'user')">

            <!-- 角色行 -->
            <div class="more-profile-row">
                <img id="more-char-avatar" class="more-avatar" src="" onerror="this.style.backgroundColor='var(--input-bg)'" onclick="document.getElementById('more-char-avatar-input').click()">
                <div class="more-name-wrapper" onclick="viewSettingDetails('char')">
                    <span class="more-role-label">角色真名</span>
                    <span id="more-char-name" class="more-name-text">Role Name</span>
                </div>
            </div>

            <!-- 用户行 -->
            <div class="more-profile-row">
                <img id="more-user-avatar" class="more-avatar" src="" onerror="this.style.backgroundColor='var(--input-bg)'" onclick="document.getElementById('more-user-avatar-input').click()">
                <div class="more-name-wrapper" onclick="viewSettingDetails('user')">
                    <span class="more-role-label">用户真名</span>
                    <span id="more-user-name" class="more-name-text">User Name</span>
                </div>
            </div>

            <div class="input-group" style="width: 100%;">
                <label class="input-label">给角色的备注</label>
                <input type="text" class="form-input" id="more-remark" oninput="saveMoreSettings()">
            </div>

            <div class="input-group" style="width: 100%;">
                <label class="input-label">绑定世界书</label>
                <!-- 修改为只读，点击触发选择弹窗 -->
                <input type="text" class="form-input" id="more-worldbook" placeholder="点击选择世界书" readonly onclick="openWorldbookSelect()">
            </div>

            <div class="input-group" style="width: 100%;">
                <label class="input-label">记忆条数</label>
                <input type="number" class="form-input" id="more-memory" value="20" oninput="saveMoreSettings()">
            </div>

            <!-- 新增：聊天总条数 -->
            <div class="input-group" style="width: 100%;">
                <label class="input-label">聊天总条数</label>
                <input type="text" class="form-input" id="more-total-count" value="0" readonly style="color: var(--gray-text); cursor: default;">
            </div>

            <!-- 总结列表区域 -->
            <div class="input-group" style="width: 100%;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <label class="input-label" style="margin-bottom: 0;">总结列表 (AI会自动读取)</label>
                    <button class="btn-pull" style="width: auto; padding: 5px 10px; margin: 0; font-size: 12px;" onclick="triggerManualSummary()">手动总结</button>
                </div>
                <div id="summary-list-container">
                    <!-- JS 填充总结列表 -->
                </div>
            </div>

            <!-- 新增：自定义总结提示词 -->
            <div class="input-group" style="width: 100%;">
                <label class="input-label">自定义总结提示词 (可选)</label>
                <textarea class="form-textarea" id="more-summary-prompt" placeholder="留空则使用默认格式。&#10;可用变量: {{char}}代表角色名, {{user}}代表用户名。&#10;AI会自动在提示词后附带聊天记录。" style="height: 100px;" oninput="saveMoreSettings()"></textarea>
            </div>

            <button class="btn-block" onclick="exportChat()">导出所有聊天记录</button>
            
            <input type="file" id="import-chat-input" accept=".json" style="display: none;" onchange="importChat(event)">
            <button class="btn-block" onclick="document.getElementById('import-chat-input').click()">导入聊天记录</button>
            
            <button class="btn-block btn-danger" onclick="clearChatHistory()">删除所有聊天记录</button>
        </div>
    </div>

    <!-- 总结编辑弹窗 -->
    <div class="modal-overlay" id="summary-edit-overlay" onclick="if(event.target===this) document.getElementById('summary-edit-overlay').classList.remove('show')">
        <div class="modal">
            <div class="modal-title">编辑总结</div>
            <textarea class="form-textarea" id="summary-edit-content" style="height: 200px;"></textarea>
            <div class="modal-btns">
                <button class="modal-btn btn-cancel" onclick="document.getElementById('summary-edit-overlay').classList.remove('show')">取消</button>
                <button class="modal-btn" style="background-color: white; color: black;" onclick="saveEditedSummary()">保存</button>
            </div>
        </div>
    </div>

    <!-- 查看设定详情弹窗 (新增) -->
    <div class="modal-overlay" id="view-details-overlay" onclick="if(event.target===this) document.getElementById('view-details-overlay').classList.remove('show')">
        <div class="modal">
            <div class="modal-title" id="view-details-title">设定详情</div>
            <div id="view-details-content"></div>
            <div class="modal-btns">
                <button class="modal-btn" style="background-color: white; color: black;" onclick="document.getElementById('view-details-overlay').classList.remove('show')">关闭</button>
            </div>
        </div>
    </div>

    <!-- 世界书选择弹窗 (多选) -->
    <div class="modal-overlay" id="wb-select-overlay" onclick="if(event.target===this) document.getElementById('wb-select-overlay').classList.remove('show')">
        <div class="modal">
            <div class="modal-title">选择世界书</div>
            <div id="wb-select-list" class="wb-select-list">
                <!-- JS 填充 -->
            </div>
            <div class="modal-btns" style="margin-top: 10px;">
                <button class="modal-btn btn-cancel" onclick="document.getElementById('wb-select-overlay').classList.remove('show')">取消</button>
                <button class="modal-btn" style="background-color: white; color: black;" onclick="saveWorldbookSelection()">确定</button>
            </div>
        </div>
    </div>

    <!-- 人物设定界面 (合并了角色和用户设定) -->
    <div id="settings-page" class="page">
        <div class="nav-bar">
            <button class="nav-btn" onclick="closeSettings()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </button>
            <div class="nav-title" id="settings-title">角色设定</div>
            <button class="nav-btn" onclick="openAddModal()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            </button>
        </div>

        <!-- 移除了 Tab 栏，直接是列表 -->
        <div class="list-content" id="list-container"></div>
    </div>

    <!-- API 设置界面 -->
    <div id="api-page" class="page">
        <div class="nav-bar">
            <button class="nav-btn" onclick="closeApiSettings()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </button>
            <div class="nav-title">API设置</div>
            <button class="nav-btn" onclick="addApiPreset()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            </button>
        </div>

        <div class="api-content">
            <div class="input-group">
                <label class="input-label">API 地址</label>
                <input type="text" class="form-input" id="api-url">
            </div>

            <div class="input-group">
                <label class="input-label">API 密钥</label>
                <input type="password" class="form-input" id="api-key">
            </div>

            <div class="input-group">
                <label class="input-label">模型名称</label>
                <!-- 初始状态为文本框 -->
                <input type="text" class="form-input" id="api-model">
                <button class="btn-pull" onclick="pullModel()">拉取模型</button>
            </div>

            <div class="input-group">
                <label class="input-label">破限</label>
                <textarea class="jailbreak-input" id="api-jailbreak" placeholder="在此输入破限内容..."></textarea>
            </div>

            <div class="api-section-title">配置预设</div>
            <div class="preset-list" id="preset-list">
                <div style="text-align: center; color: #555; padding: 20px;">暂无预设</div>
            </div>

            <button class="btn-save-api" onclick="saveApiConfig()">保存</button>
        </div>
    </div>

    <!-- 主设置界面 -->
    <div id="main-settings-page" class="page">
        <div class="nav-bar">
            <button class="nav-btn" onclick="closeMainSettings()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </button>
            <div class="nav-title">主设置</div>
            <div class="nav-btn"></div>
        </div>
        <div class="settings-content">
            <!-- 顶部栏位置调整 -->
            <div class="input-group">
                <label class="input-label">调整顶部栏位置 (适配刘海屏)</label>
                <!-- 修改：删除了 background: #333; 让其自动跟随 CSS 变量变为浅灰 -->
                <input type="range" class="form-input" id="nav-pos-slider" min="15" max="60" value="15" style="padding: 0; height: 40px;" oninput="adjustNavPosition(this.value)">
            </div>

            <!-- 新增：切换日间/夜间模式 -->
            <div class="input-group">
                <label class="input-label">显示模式</label>
                <button class="btn-block" style="margin-top:0;" onclick="toggleTheme()" id="theme-toggle-btn">切换为日间模式</button>
            </div>

            <!-- 新增：修改桌面背景 -->
            <div class="input-group">
                <label class="input-label">修改桌面背景</label>
                <button class="btn-block" style="margin-top:0;" onclick="document.getElementById('desktop-bg-input').click()">选择图片</button>
                <button class="btn-pull" onclick="resetDesktopBg()">重置背景</button>
                <input type="file" id="desktop-bg-input" accept="image/*" style="display: none;" onchange="handleDesktopBgUpload(event)">
            </div>

            <!-- 修改聊天背景 (原位置) -->
            <div class="input-group">
                <label class="input-label">修改聊天背景</label>
                <button class="btn-block" style="margin-top:0;" onclick="document.getElementById('bg-upload-input').click()">选择图片</button>
                <button class="btn-pull" onclick="resetChatBg()">重置背景</button>
                <input type="file" id="bg-upload-input" accept="image/*" style="display: none;" onchange="handleBgUpload(event)">
            </div>

            <!-- 新增：修改桌面图标 -->
            <div class="input-group">
                <label class="input-label">修改桌面图标</label>
                <select class="form-input" id="icon-select" style="margin-bottom: 10px;">
                    <option value="inner">里世界</option>
                    <option value="char">人物设定</option>
                    <option value="wb">世界书</option>
                    <option value="api">API设置</option>
                    <option value="outer">外世界</option>
                    <option value="main">主设置</option>
                </select>
                <button class="btn-block" style="margin-top:0;" onclick="document.getElementById('icon-upload-input').click()">上传图标图片</button>
                <button class="btn-pull" onclick="resetSelectedIcon()">重置该图标</button>
                <input type="file" id="icon-upload-input" accept="image/*" style="display: none;" onchange="handleIconUpload(event)">
            </div>

            <!-- 自定义气泡 CSS -->
            <div class="input-group">
                <label class="input-label">自定义聊天气泡 CSS</label>
                
                <!-- 新增：气泡样式预览 -->
                <div style="background-color: var(--item-bg); padding: 20px; border-radius: 12px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 10px;">
                    <div style="font-size: 12px; color: var(--gray-text); margin-bottom: 5px;">样式预览：</div>
                    <div style="display: flex; justify-content: flex-start;">
                        <div class="chat-bubble char">角色气泡预览</div>
                    </div>
                    <div style="display: flex; justify-content: flex-end;">
                        <div class="chat-bubble user">用户气泡预览</div>
                    </div>
                </div>

                <textarea class="form-textarea" id="custom-css-input" style="height: 200px; font-family: monospace; font-size: 12px;">.chat-bubble {
    position: relative; 
    padding: 8px 12px; 
    border-radius: 8px; 
    font-size: 15px; 
    line-height: 1.5;
    word-wrap: break-word;
    max-width: 100%; 
    user-select: none; 
    -webkit-user-select: none;
    -webkit-touch-callout: none !important;
    -webkit-user-drag: none;
}</textarea>
                <button class="btn-pull" onclick="saveCustomCSS()">保存并预览</button>
            </div>

            <!-- 导入导出 -->
            <button class="btn-block" onclick="exportAllData()">导出所有数据 (备份)</button>
            <button class="btn-block" onclick="document.getElementById('import-all-input').click()">导入所有数据 (恢复)</button>
            <input type="file" id="import-all-input" accept=".json" style="display: none;" onchange="importAllData(event)">

            <hr style="border: 0; border-top: 1px solid #333; margin: 20px 0;">

            <button class="btn-clear-data" onclick="clearAllData()">清除所有数据</button>
        </div>
    </div>

<style id="custom-bubble-style"></style>

    <!-- 世界书界面 (新增) -->
    <div id="worldbook-page" class="page">
        <div class="nav-bar">
            <button class="nav-btn" onclick="closeWorldbook()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </button>
            <div class="nav-title">世界书</div>
            <button class="nav-btn" onclick="openAddWorldbookModal()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            </button>
        </div>
        <div class="list-content" id="wb-list-container">
            <div style="text-align: center; color: #555; margin-top: 50px;">暂无世界书，点击右上角加号添加。</div>
        </div>
    </div>

    <!-- 添加/编辑 世界书弹窗 -->
    <div class="modal-overlay" id="wb-add-overlay" onclick="if(event.target===this) document.getElementById('wb-add-overlay').classList.remove('show')">
        <div class="modal">
            <div class="modal-title" id="wb-modal-title">添加世界书</div>
            
            <label class="input-label">世界书名称</label>
            <input type="text" class="form-input" id="wb-name">

            <label class="input-label">世界书内容</label>
            <textarea class="form-textarea" id="wb-content"></textarea>

            <label class="input-label">世界书分类 (选填)</label>
            <div class="category-input-wrapper">
                <input type="text" class="form-input" id="wb-category" placeholder="输入或选择分类">
                <!-- 下拉选择图标，只有有历史分类时才显示 -->
                <div id="wb-category-arrow" class="category-select-icon" style="display:none;" onclick="toggleCategoryDropdown()">
                    ▼
                </div>
                <div id="category-dropdown">
                    <!-- JS 填充选项 -->
                </div>
            </div>

            <div class="modal-btns" style="margin-top: 20px;">
                <button class="modal-btn btn-cancel" onclick="document.getElementById('wb-add-overlay').classList.remove('show')">取消</button>
                <button class="modal-btn" style="background-color: white; color: black;" onclick="saveWorldbook()">保存</button>
            </div>
        </div>
    </div>

    <!-- 添加/编辑 人物设定 弹窗 -->
    <div class="modal-overlay" id="modal-overlay" onclick="handleOverlayClick(event)">
        <div class="modal">
            <div class="modal-title" id="modal-title">添加角色设定</div>
            
            <input type="file" id="avatar-input" accept="image/*" style="display: none;" onchange="handleFileSelect(event)">
            
            <div class="avatar-upload" onclick="document.getElementById('avatar-input').click()">
                <img id="avatar-preview" src="" alt="Avatar">
                <svg class="avatar-icon" id="avatar-placeholder" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                </svg>
            </div>

            <label class="input-label">真名</label>
            <input type="text" class="form-input" id="input-name" oninput="checkForm()">
            
            <label class="input-label">设定详情</label>
            <textarea class="form-textarea" id="input-desc" oninput="checkForm()"></textarea>

            <div class="modal-btns">
                <button class="modal-btn btn-cancel" onclick="closeModal()">取消</button>
                <button class="modal-btn btn-save" id="btn-save" onclick="saveData()">保存</button>
            </div>
        </div>
    </div>

    <!-- 选择人物弹窗 -->
    <div class="modal-overlay" id="chat-setup-overlay" onclick="if(event.target===this) document.getElementById('chat-setup-overlay').classList.remove('show')">
        <div class="modal">
            <div class="modal-title">开始聊天</div>
            
            <label class="input-label">选择角色</label>
            <select class="form-input" id="select-character">
                <option value="">请选择角色...</option>
            </select>

            <label class="input-label" style="margin-top: 15px;">选择用户</label>
            <select class="form-input" id="select-user">
                <option value="">请选择用户...</option>
            </select>

            <div class="modal-btns" style="margin-top: 25px;">
                <button class="modal-btn btn-cancel" onclick="document.getElementById('chat-setup-overlay').classList.remove('show')">取消</button>
                <button class="modal-btn" style="background-color: white; color: black;" onclick="startChat()">进入</button>
            </div>
        </div>
    </div>

    <!-- 角色心声弹窗 (适配日夜模式版) -->
    <div class="modal-overlay" id="mind-modal-overlay" onclick="if(event.target===this) document.getElementById('mind-modal-overlay').classList.remove('show')">
        <div class="modal" style="width: 85%; max-width: 340px;">
            <div style="display: flex; flex-direction: column; align-items: center; width: 100%;">
                <!-- 头像 -->
                <img id="mind-avatar" src="" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid var(--border-color); margin-bottom: 15px; background-color: var(--input-bg);">
                
                <!-- 真名 -->
                <div id="mind-name" style="font-size: 20px; font-weight: bold; margin-bottom: 20px; color: var(--text-color);"></div>
                
                <!-- 状态 -->
                <div style="width: 100%; text-align: left; margin-bottom: 15px;">
                    <div style="font-size: 12px; color: var(--gray-text); margin-bottom: 5px;">当前状态</div>
                    <div id="mind-status" style="font-size: 15px; color: var(--edit-color); font-weight: bold;"></div>
                </div>

                <!-- 心声 -->
                <div style="width: 100%; text-align: left; margin-bottom: 15px;">
                    <div style="font-size: 12px; color: var(--gray-text); margin-bottom: 5px;">内心想法</div>
                    <div id="mind-thoughts" style="font-size: 15px; color: var(--text-color); line-height: 1.5; white-space: pre-wrap;"></div>
                </div>

                <!-- 想做的事 -->
                <div style="width: 100%; text-align: left; margin-bottom: 20px;">
                    <div style="font-size: 12px; color: var(--gray-text); margin-bottom: 5px;">想做的事</div>
                    <div id="mind-wants" style="font-size: 15px; color: var(--pin-color); line-height: 1.5; white-space: pre-wrap;"></div>
                </div>
            </div>
            
            <div class="modal-btns">
                <button class="modal-btn" style="background-color: var(--btn-bg); color: var(--btn-text); border: 1px solid var(--border-color);" onclick="document.getElementById('mind-modal-overlay').classList.remove('show')">关闭</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== 原生 IndexedDB 存储逻辑 (智能兼容版) ====================
        const DB_NAME = 'MiyoDB';
        const STORE_NAME = 'miyo_store';
        let dbInstance = null;

        // 打开/初始化数据库
        function openDB() {
            return new Promise((resolve, reject) => {
                if (dbInstance) return resolve(dbInstance);

                // 关键修改：不指定版本号，自动打开当前存在的版本（兼容 Dexie 创建的 Version 10）
                const request = indexedDB.open(DB_NAME);

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                    }
                };

                request.onsuccess = (event) => {
                    const db = event.target.result;
                    
                    // 检查表是否存在（防止新用户没有表）
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        // 如果表不存在，我们需要关闭连接并以更高版本重新打开来触发升级
                        const currentVersion = db.version;
                        db.close();
                        
                        const upgradeReq = indexedDB.open(DB_NAME, currentVersion + 1);
                        upgradeReq.onupgradeneeded = (e) => {
                            const dbUp = e.target.result;
                            if (!dbUp.objectStoreNames.contains(STORE_NAME)) {
                                dbUp.createObjectStore(STORE_NAME, { keyPath: 'id' });
                            }
                        };
                        upgradeReq.onsuccess = (e) => {
                            dbInstance = e.target.result;
                            resolve(dbInstance);
                        };
                        upgradeReq.onerror = (e) => reject(e.target.error);
                    } else {
                        // 表存在，直接使用
                        dbInstance = db;
                        resolve(dbInstance);
                    }
                };

                request.onerror = (event) => {
                    console.error("IndexedDB 打开失败:", event.target.error);
                    // 如果是因为版本问题（很少见，但为了保险），尝试恢复
                    reject(event.target.error);
                };
            });
        }

        // 保存数据函数
        async function saveToDB(key, value) {
            try {
                const db = await openDB();
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.put({ id: key, data: value });

                    request.onsuccess = () => resolve();
                    request.onerror = (e) => {
                        console.error("写入失败:", e.target.error);
                        reject(e.target.error);
                    };
                });
            } catch (error) {
                console.error("saveToDB 错误:", error);
            }
        }

        // 读取数据函数
        async function loadFromDB(key) {
            try {
                const db = await openDB();
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([STORE_NAME], 'readonly');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.get(key);

                    request.onsuccess = () => {
                        const result = request.result;
                        resolve(result ? result.data : null);
                    };
                    request.onerror = (e) => {
                        console.error("读取失败:", e.target.error);
                        reject(e.target.error);
                    };
                });
            } catch (error) {
                console.error("loadFromDB 错误:", error);
                return null;
            }
        }

        // ==================== 全局状态 ====================
        let currentTab = 'character'; 
        let isEditing = false;
        let editId = null;
        let welcomeStep = 0; 
        let isToolbarOpen = false;
        let currentTheme = localStorage.getItem('miyo_theme') || 'dark'; // 默认为夜间模式

        // 核心数据
        let dataStore = {
            character: [],
            user: []
        };
        let apiPresets = [];
        let chatSessions = []; // {id, charIndex, userIndex, messages: [], pinned: false, settings: {}}
        let currentChatSessionId = null;
        let worldbooks = []; // 世界书数据
        let isEditingWb = false;
        let editWbId = null;
        let tempSelectedWorldbooks = []; // 临时存储多选的世界书ID
        let customEmojis = []; // 表情包数据 [{url: '...', desc: '...'}, ...]
        let isEmojiDeleteMode = false;
        let tempPhotoData = null; // 临时存储照片数据
        let editingSummaryId = null; // 正在编辑的总结ID

        // 引用和多选状态
        let currentQuote = null; // { content: string, name: string, role: string }
        let isMultiSelectMode = false;
        let longPressTimer;
        let currentLongPressMsgIndex = -1;
        
        // 新增：编辑状态变量
        let isEditingMessage = false;
        let currentRenderLimit = 20; // 当前渲染的消息数量限制
        let editingMessageIndex = -1;

        // 初始化加载数据
        window.onload = async function() {
            
            // 1. 应用主题与加载资源 (核心修改)
            applyThemeToDOM();       // 应用 CSS 变量
            await loadThemeResources(); // 加载对应模式的图片/CSS

            // 启动时钟
            startClock();

            // 加载顶部栏位置
            const savedNavPos = localStorage.getItem('miyo_nav_pos');
            if (savedNavPos) {
                document.documentElement.style.setProperty('--nav-top-padding', savedNavPos + 'px');
                const slider = document.getElementById('nav-pos-slider');
                if(slider) slider.value = savedNavPos;
            }

            // 加载原有数据 (DataStore等)
            const loadedData = await loadFromDB('dataStore');
            if (loadedData) dataStore = loadedData;
            
            const loadedPresets = await loadFromDB('apiPresets');
            if (loadedPresets) apiPresets = loadedPresets;

            const loadedSessions = await loadFromDB('chatSessions');
            if (loadedSessions && Array.isArray(loadedSessions)) chatSessions = loadedSessions;
            else chatSessions = []; 

            const loadedWorldbooks = await loadFromDB('worldbooks');
            if (loadedWorldbooks && Array.isArray(loadedWorldbooks)) worldbooks = loadedWorldbooks;
            else worldbooks = []; 

            const loadedEmojis = await loadFromDB('customEmojis');
            if (loadedEmojis) {
                if (loadedEmojis.length > 0 && typeof loadedEmojis[0] === 'string') {
                    customEmojis = loadedEmojis.map(url => ({ url: url, desc: '表情包' }));
                    saveToDB('customEmojis', customEmojis);
                } else {
                    customEmojis = loadedEmojis;
                }
            }

            const loadedApiConfig = await loadFromDB('currentApiConfig');
            if (loadedApiConfig) {
                document.getElementById('api-url').value = loadedApiConfig.url || '';
                document.getElementById('api-key').value = loadedApiConfig.key || '';
                document.getElementById('api-jailbreak').value = loadedApiConfig.jailbreak || '';
                if (loadedApiConfig.model) {
                    resetModelInput(loadedApiConfig.model);
                }
            }

            document.getElementById('chat-input-box').addEventListener('keydown', function(e) { 
                if (e.key === 'Enter') {
                    if (e.shiftKey || this.classList.contains('expanded')) {
                        return; 
                    }
                    e.preventDefault(); 
                    sendMessage();
                }
            });

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.context-menu') && !e.target.closest('.chat-bubble')) {
                    hideContextMenu();
                }
            });
        };

        // ==================== 页面切换逻辑 ====================
        function openSettings() {
            currentTab = 'character';
            updateSettingsUI();
            document.getElementById('settings-page').classList.add('active');
            renderList();
        }
        function closeSettings() {
            document.getElementById('settings-page').classList.remove('active');
        }

        function openApiSettings() {
            document.getElementById('api-page').classList.add('active');
            renderPresets();
        }
        function closeApiSettings() {
            document.getElementById('api-page').classList.remove('active');
        }

        function openMainSettings() {
            document.getElementById('main-settings-page').classList.add('active');
        }
        function closeMainSettings() {
            document.getElementById('main-settings-page').classList.remove('active');
        }

        // --- 世界书逻辑 (新增) ---
        function openWorldbook() {
            document.getElementById('worldbook-page').classList.add('active');
            renderWorldbookList();
        }
        function closeWorldbook() {
            document.getElementById('worldbook-page').classList.remove('active');
        }

        function openAddWorldbookModal() {
            isEditingWb = false;
            editWbId = null;
            document.getElementById('wb-modal-title').innerText = '添加世界书';
            document.getElementById('wb-name').value = '';
            document.getElementById('wb-content').value = '';
            document.getElementById('wb-category').value = '';
            
            checkWorldbookCategories();
            document.getElementById('wb-add-overlay').classList.add('show');
        }

        function openEditWorldbookModal(id) {
            const wb = worldbooks.find(w => w.id === id);
            if(!wb) return;

            isEditingWb = true;
            editWbId = id;
            document.getElementById('wb-modal-title').innerText = '编辑世界书';
            document.getElementById('wb-name').value = wb.name;
            document.getElementById('wb-content').value = wb.content;
            document.getElementById('wb-category').value = wb.category || '';

            checkWorldbookCategories();
            document.getElementById('wb-add-overlay').classList.add('show');
            // 复位列表
            renderWorldbookList();
        }

        function checkWorldbookCategories() {
            const categories = [...new Set(worldbooks.map(wb => wb.category).filter(c => c))];
            const arrow = document.getElementById('wb-category-arrow');
            const dropdown = document.getElementById('category-dropdown');
            
            dropdown.innerHTML = '';
            dropdown.classList.remove('show');

            if (categories.length > 0) {
                arrow.style.display = 'block';
                categories.forEach(cat => {
                    const div = document.createElement('div');
                    div.className = 'category-option';
                    div.innerText = cat;
                    div.onclick = () => {
                        document.getElementById('wb-category').value = cat;
                        dropdown.classList.remove('show');
                    };
                    dropdown.appendChild(div);
                });
            } else {
                arrow.style.display = 'none';
            }
        }

        function toggleCategoryDropdown() {
            document.getElementById('category-dropdown').classList.toggle('show');
        }

        async function saveWorldbook() {
            const name = document.getElementById('wb-name').value.trim();
            const content = document.getElementById('wb-content').value.trim();
            const category = document.getElementById('wb-category').value.trim();

            if (!name || !content) {
                alert("世界书名称和内容必须填写");
                return;
            }

            try {
                // 安全检查：确保 worldbooks 是数组
                if (!Array.isArray(worldbooks)) {
                    worldbooks = [];
                }

                if (isEditingWb) {
                    const index = worldbooks.findIndex(w => w.id === editWbId);
                    if (index !== -1) {
                        worldbooks[index] = { id: editWbId, name, content, category };
                    }
                } else {
                    worldbooks.push({
                        id: Date.now().toString(),
                        name: name,
                        content: content,
                        category: category
                    });
                }

                // 等待保存完成
                await saveToDB('worldbooks', worldbooks);
                
                // 保存成功后关闭弹窗并刷新列表
                document.getElementById('wb-add-overlay').classList.remove('show');
                renderWorldbookList();
                
            } catch (error) {
                console.error(error);
                alert("保存失败: " + error.message);
            }
        }

        function deleteWorldbook(id) {
            if(confirm('确定要删除这本世界书吗？')) {
                worldbooks = worldbooks.filter(w => w.id !== id);
                saveToDB('worldbooks', worldbooks);
                renderWorldbookList();
            } else {
                renderWorldbookList();
            }
        }

        function renderWorldbookList() {
            const container = document.getElementById('wb-list-container');
            container.innerHTML = '';

            if (worldbooks.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #555; margin-top: 50px;">暂无世界书，点击右上角加号添加。</div>';
                return;
            }

            // 分组逻辑
            const grouped = {};
            worldbooks.forEach(wb => {
                const cat = wb.category || '【默认】';
                if (!grouped[cat]) grouped[cat] = [];
                grouped[cat].push(wb);
            });

            for (const cat in grouped) {
                // 分类标题
                const header = document.createElement('div');
                header.className = 'wb-category-header';
                header.innerText = cat;
                container.appendChild(header);

                // 该分类下的书籍
                grouped[cat].forEach(wb => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'list-item-wrapper'; // 复用列表样式以支持左滑

                    const actions = document.createElement('div');
                    actions.className = 'list-item-actions';
                    
                    const editBtn = document.createElement('button');
                    editBtn.className = 'action-btn btn-edit';
                    editBtn.innerText = '编辑';
                    editBtn.onclick = () => openEditWorldbookModal(wb.id);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'action-btn btn-delete';
                    deleteBtn.innerText = '删除';
                    deleteBtn.onclick = () => deleteWorldbook(wb.id);

                    actions.appendChild(editBtn);
                    actions.appendChild(deleteBtn);

                    const content = document.createElement('div');
                    content.className = 'wb-item-content'; // 新增样式类
                    content.innerHTML = `
                        <div class="wb-title">${wb.name}</div>
                        <div class="wb-preview">${wb.content}</div>
                    `;

                    // 点击展开详情
                    content.onclick = (e) => {
                        if(Math.abs(wbTouchEndX - wbTouchStartX) > 10) return;
                        content.classList.toggle('expanded');
                    };

                    // 左滑逻辑
                    let wbTouchStartX = 0;
                    let wbTouchEndX = 0;
                    content.addEventListener('touchstart', (e) => {
                        wbTouchStartX = e.changedTouches[0].screenX;
                        document.querySelectorAll('.wb-item-content').forEach(el => {
                            if(el !== content) el.style.transform = 'translateX(0)';
                        });
                    }, {passive: true});

                    content.addEventListener('touchmove', (e) => {
                        wbTouchEndX = e.changedTouches[0].screenX;
                        let diff = wbTouchEndX - wbTouchStartX;
                        if (diff < 0 && diff > -160) {
                            content.style.transform = `translateX(${diff}px)`;
                        }
                    }, {passive: true});

                    content.addEventListener('touchend', (e) => {
                        wbTouchEndX = e.changedTouches[0].screenX;
                        let diff = wbTouchEndX - wbTouchStartX;
                        if (diff < -60) {
                            content.style.transform = 'translateX(-140px)';
                        } else {
                            content.style.transform = 'translateX(0)';
                        }
                        wbTouchStartX = 0;
                        wbTouchEndX = 0;
                    });

                    wrapper.appendChild(actions);
                    wrapper.appendChild(content);
                    container.appendChild(wrapper);
                });
            }
        }


        async function clearAllData() {
            if(confirm("确定要清除所有数据吗？这将无法恢复。")) {
                localStorage.clear();
                
                // 关闭当前数据库连接
                if (dbInstance) {
                    dbInstance.close();
                    dbInstance = null;
                }

                // 原生删除数据库
                const request = indexedDB.deleteDatabase(DB_NAME);
                
                request.onsuccess = () => {
                    alert("所有数据已清除，即将重启。");
                    location.reload();
                };
                
                request.onerror = (e) => {
                    alert("清除数据失败: " + e.target.error);
                    location.reload(); // 即使报错也尝试刷新
                };
                
                request.onblocked = () => {
                    // 如果有其他标签页打开了数据库，可能会阻塞
                    alert("清除操作被阻塞，请关闭其他页面后重试，正在强制刷新...");
                    location.reload();
                };
            }
        }

        // --- 里世界逻辑 ---
        function openInnerWorld() {
            if (localStorage.getItem('miyo_welcome_shown')) {
                document.getElementById('chat-list-page').classList.add('active');
                renderChatList();
                return;
            }

            welcomeStep = 0;
            const welcomePage = document.getElementById('welcome-page');
            const textContainer = document.getElementById('welcome-text-container');
            const btnContainer = document.getElementById('welcome-btn-container');
            
            textContainer.innerHTML = "大人，欢迎来到里世界";
            textContainer.style.display = 'flex';
            textContainer.style.height = '100%'; 
            textContainer.style.marginBottom = '0';
            btnContainer.style.display = 'none';
            
            welcomePage.classList.add('active');
        }

        function handleWelcomeClick() {
            const textContainer = document.getElementById('welcome-text-container');
            const btnContainer = document.getElementById('welcome-btn-container');

            if (welcomeStep === 0) {
                textContainer.innerHTML = "可在里世界<br>与您的那个TA进行互动";
                welcomeStep = 1;
            } else if (welcomeStep === 1) {
                textContainer.innerHTML = "请确认是否已配置API";
                btnContainer.style.display = 'flex';
                textContainer.style.height = 'auto';
                textContainer.style.marginBottom = '20px';
                welcomeStep = 2;
            }
        }

        function goToApiFromWelcome(e) {
            e.stopPropagation(); 
            openApiSettings();
        }

        function checkApiAndEnter(e) {
            e.stopPropagation(); 
            
            const url = document.getElementById('api-url').value.trim();
            const key = document.getElementById('api-key').value.trim();

            if (!url || !key) {
                alert("大人，您还未配置API哦");
            } else {
                const textContainer = document.getElementById('welcome-text-container');
                const btnContainer = document.getElementById('welcome-btn-container');
                
                btnContainer.style.display = 'none';
                textContainer.innerText = "即将进入";
                
                localStorage.setItem('miyo_welcome_shown', 'true');

                setTimeout(() => {
                    document.getElementById('chat-list-page').classList.add('active');
                    document.getElementById('welcome-page').classList.remove('active');
                    renderChatList();
                }, 1000);
            }
        }

        function closeChatList() {
            document.getElementById('chat-list-page').classList.remove('active');
            if (isMultiSelectMode) {
                cancelMultiSelect();
            }
        }

        // --- 聊天选择与进入逻辑 ---
        function openChatSetup() {
            const charSelect = document.getElementById('select-character');
            const userSelect = document.getElementById('select-user');
            
            charSelect.innerHTML = '<option value="">请选择角色...</option>';
            userSelect.innerHTML = '<option value="">请选择用户...</option>';

            dataStore.character.forEach((char, index) => {
                const opt = document.createElement('option');
                opt.value = index;
                opt.text = char.name;
                charSelect.add(opt);
            });

            dataStore.user.forEach((user, index) => {
                const opt = document.createElement('option');
                opt.value = index;
                opt.text = user.name;
                userSelect.add(opt);
            });

            document.getElementById('chat-setup-overlay').classList.add('show');
        }

        let isLoadingHistory = false;


        // ==================== 核心修复：通用聊天初始化逻辑 ====================
        function initializeChatInterface(session) {
            // 1. 强制重置显示条数
            currentRenderLimit = 20;
            isLoadingHistory = false;

            const msgContainer = document.getElementById('chat-messages');
            const input = document.getElementById('chat-input-box');

            // 2. 绑定键盘弹出适配 (防止遮挡)
            input.onfocus = function() {
                setTimeout(() => { msgContainer.scrollTop = msgContainer.scrollHeight; }, 300);
                setTimeout(() => { msgContainer.scrollTop = msgContainer.scrollHeight; }, 600);
            };

            // 3. 绑定滚动加载逻辑 (先解绑旧的)
            if (msgContainer._scrollHandler) {
                msgContainer.removeEventListener('scroll', msgContainer._scrollHandler);
            }

            msgContainer._scrollHandler = function() {
                if (!session || isLoadingHistory) return;
                if (session.messages.length <= currentRenderLimit) return;

                // 阈值 10px
                if (msgContainer.scrollTop <= 10) {
                    isLoadingHistory = true;
                    const oldScrollHeight = msgContainer.scrollHeight;
                    
                    currentRenderLimit += 20;
                    renderMessages(session.messages, true);
                    
                    requestAnimationFrame(() => {
                        const newScrollHeight = msgContainer.scrollHeight;
                        msgContainer.scrollTop = newScrollHeight - oldScrollHeight;
                        setTimeout(() => { isLoadingHistory = false; }, 100);
                    });
                }
            };
            msgContainer.addEventListener('scroll', msgContainer._scrollHandler);

            // 4. 初始渲染 (只显示最后20条)
            renderMessages(session.messages, false);

            // 5. 显示界面
            document.getElementById('chat-interface-page').classList.add('active');
        }

        function startChat() {
            const charIndex = document.getElementById('select-character').value;
            const userIndex = document.getElementById('select-user').value;

            if (charIndex === "" || userIndex === "") {
                alert("请先选择角色和用户");
                return;
            }

            const sessionId = `${charIndex}_${userIndex}`;
            currentChatSessionId = sessionId;

            const charName = dataStore.character[charIndex].name;
            document.getElementById('chat-title').innerText = charName;
            
            let session = chatSessions.find(s => s.id === sessionId);
            if (!session) {
                // 如果是新会话，创建一个临时的空对象传进去，防止报错
                // 实际保存会在发送消息时进行
                session = { messages: [] };
            }

            // 调用通用初始化函数
            initializeChatInterface(session);

            document.getElementById('chat-setup-overlay').classList.remove('show');
        }

        function renderMessages(messages, isHistoryLoad = false) {
            const container = document.getElementById('chat-messages');
            
            // 如果不是加载历史，清空容器重新渲染
            if (!isHistoryLoad) {
                container.innerHTML = '';
            } else {
                // 如果是加载历史，我们需要清空并重新构建整个列表，因为要插入新的头部消息
                // 简单的做法是直接清空重绘，只要保持滚动位置即可
                container.innerHTML = '';
            }
            
            const session = chatSessions.find(s => s.id === currentChatSessionId);
            let userAvatar = '';
            let charAvatar = '';
            
            if (session) {
                userAvatar = dataStore.user[session.userIndex].avatar;
                charAvatar = dataStore.character[session.charIndex].avatar;
            } else {
                const charIndex = document.getElementById('select-character').value;
                const userIndex = document.getElementById('select-user').value;
                if(charIndex && userIndex) {
                    userAvatar = dataStore.user[userIndex].avatar;
                    charAvatar = dataStore.character[charIndex].avatar;
                }
            }

            // --- 分页切片逻辑 ---
            const totalMessages = messages.length;
            // 确保 currentRenderLimit 至少为 20
            if (currentRenderLimit < 20) currentRenderLimit = 20;
            
            const startIndex = Math.max(0, totalMessages - currentRenderLimit);
            const visibleMessages = messages.slice(startIndex);

            // --- 核心修复：只要有隐藏消息，就显示按钮 ---
            if (startIndex > 0) {
                const loadBtn = document.createElement('div');
                loadBtn.style.textAlign = 'center';
                loadBtn.style.padding = '10px';
                loadBtn.style.fontSize = '12px';
                loadBtn.style.color = '#4d94ff';
                loadBtn.style.cursor = 'pointer';
                loadBtn.innerText = `点击加载更多历史消息 (${startIndex}条未显示)`; // 增加提示
                loadBtn.onclick = function() {
                    // 手动触发加载逻辑
                    const msgContainer = document.getElementById('chat-messages');
                    const oldScrollHeight = msgContainer.scrollHeight;
                    
                    currentRenderLimit += 20;
                    renderMessages(messages, true);
                    
                    // 修正滚动位置
                    // 注意：这里需要延时一点点，等待DOM更新
                    requestAnimationFrame(() => {
                        const newScrollHeight = msgContainer.scrollHeight;
                        msgContainer.scrollTop = newScrollHeight - oldScrollHeight;
                    });
                };
                container.appendChild(loadBtn);
            }

            let lastMsgTime = 0;

            visibleMessages.forEach((msg, i) => {
                const realIndex = startIndex + i;

                // 1. 系统时间显示逻辑
                const msgTime = msg.timestamp || 0;
                if (msgTime > 0 && (msgTime - lastMsgTime > 600000)) {
                    const timeDiv = document.createElement('div');
                    timeDiv.className = 'chat-system-time';
                    if (isMultiSelectMode) {
                        timeDiv.onclick = function() { this.classList.toggle('selected'); };
                    }
                    const date = new Date(msgTime);
                    const timeStr = `${date.getHours().toString().padStart(2,'0')}:${date.getMinutes().toString().padStart(2,'0')}`;
                    const today = new Date();
                    let dateStr = "";
                    if (date.getDate() !== today.getDate() || date.getMonth() !== today.getMonth() || date.getFullYear() !== today.getFullYear()) {
                        dateStr = `${date.getMonth()+1}月${date.getDate()}日 `;
                    }
                    timeDiv.innerHTML = `<span>${dateStr}${timeStr}</span>`;
                    container.appendChild(timeDiv);
                }
                if (msgTime > 0) lastMsgTime = msgTime;

                // ... (中间的消息渲染逻辑保持不变，为节省篇幅省略，请保留原有的 switch/case 或 if/else 结构) ...
                // 务必保留原有的 msg.isRecalled, ST_EMOJI, ST_VOICE 等所有渲染逻辑
                
                // 2. 撤回消息渲染
                if (msg.isRecalled) {
                    const recallDiv = document.createElement('div');
                    recallDiv.className = 'sys-recall-msg';
                    if (msg.selected) recallDiv.classList.add('selected');
                    recallDiv.innerHTML = `<span>${msg.role === 'user' ? '您已撤回一条信息' : '对方已撤回一条信息'}</span>`;
                    if (isMultiSelectMode) {
                        recallDiv.onclick = (e) => { e.stopPropagation(); msg.selected = !msg.selected; renderMessages(session.messages); };
                    } else {
                        recallDiv.onclick = () => viewRecalledMessage(realIndex);
                    }
                    container.appendChild(recallDiv);
                    return; 
                }

                // 3. 普通消息渲染
                const row = document.createElement('div');
                const roleClass = msg.role === 'user' ? 'user' : 'char';
                row.className = `chat-msg-row ${roleClass}`;
                
                const avatar = document.createElement('img');
                avatar.className = 'chat-msg-avatar';
                avatar.onerror = function() { this.style.backgroundColor = 'var(--input-bg)'; };
                
                const contentWrapper = document.createElement('div');
                contentWrapper.className = 'msg-content-wrapper';

                const bubble = document.createElement('div');
                bubble.className = `chat-bubble ${roleClass}`;
                if (msg.selected) bubble.classList.add('selected');

                if (isMultiSelectMode) {
                    bubble.onclick = (e) => { e.stopPropagation(); msg.selected = !msg.selected; bubble.classList.toggle('selected'); };
                } else {
                    bubble.addEventListener('touchstart', (e) => { longPressTimer = setTimeout(() => { showContextMenu(e, realIndex, msg.role); }, 500); });
                    bubble.addEventListener('touchend', () => { clearTimeout(longPressTimer); });
                    bubble.addEventListener('touchmove', () => { clearTimeout(longPressTimer); });
                }
                
                let shouldRenderBubble = true;
                let quoteHtml = '';
                if (msg.quote) {
                    let qContent = msg.quote.content;
                    let displayContent = "";
                    if (qContent.startsWith('ST_EMOJI:')) displayContent = `<img src="${qContent.split(':::')[1]}" style="max-height: 50px; border-radius: 4px;">`;
                    else if (qContent.startsWith('ST_EMOJI_DESC:')) {
                        const desc = qContent.replace('ST_EMOJI_DESC:', '');
                        const found = customEmojis.find(e => e.desc === desc);
                        displayContent = found ? `<img src="${found.url}" style="max-height: 50px; border-radius: 4px;">` : `[表情包: ${desc}]`;
                    }
                    else if (qContent.startsWith('data:image')) displayContent = `<img src="${qContent}" style="max-height: 50px; border-radius: 4px;">`;
                    else if (qContent.startsWith('ST_VOICE:')) displayContent = `【语音 ${qContent.replace('ST_VOICE:', '').split(':::')[0]}】${qContent.replace('ST_VOICE:', '').split(':::')[1]||''}`;
                    else if (qContent.startsWith('ST_PHOTO_TEXT:')) displayContent = `【照片】${qContent.replace('ST_PHOTO_TEXT:', '')}`;
                    else if (qContent.startsWith('ST_TRANSFER:')) { try { displayContent = `【里世界转账】${JSON.parse(qContent.replace('ST_TRANSFER:', '')).amount}`; } catch(e){ displayContent = `【里世界转账】`; } }
                    else displayContent = qContent;

                    quoteHtml = `<div class="internal-quote"><div class="internal-quote-name">${msg.quote.name}:</div><div class="internal-quote-content">${displayContent}</div></div>`;
                }

                if (msg.content.startsWith('ST_EMOJI:')) {
                    const parts = msg.content.split(':::');
                    if (parts.length > 1) { bubble.innerHTML = quoteHtml + `<img src="${parts[1]}" class="chat-image">`; bubble.classList.add('has-image'); } else { shouldRenderBubble = false; }
                } else if (msg.content.startsWith('ST_EMOJI_DESC:')) {
                    const desc = msg.content.replace('ST_EMOJI_DESC:', '').trim();
                    const found = customEmojis.find(e => e.desc === desc);
                    if (found) { bubble.innerHTML = quoteHtml + `<img src="${found.url}" class="chat-image">`; bubble.classList.add('has-image'); } else { shouldRenderBubble = false; }
                } else if (msg.content.startsWith('ST_VOICE:')) {
                    const parts = msg.content.replace('ST_VOICE:', '').split(':::');
                    bubble.innerHTML = quoteHtml + `<div class="voice-bubble-container" onclick="this.classList.toggle('playing'); this.querySelector('.voice-text').classList.toggle('show')"><div class="voice-header"><div class="voice-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon></svg></div><div class="voice-wave"><div class="voice-bar"></div><div class="voice-bar"></div><div class="voice-bar"></div><div class="voice-bar"></div><div class="voice-bar"></div></div><div class="voice-seconds">${parts[0]}"</div></div><div class="voice-text">${parts[1]||''}</div></div>`;
                } else if (msg.content.startsWith('ST_PHOTO_TEXT:')) {
                    bubble.innerHTML = quoteHtml + `<div class="photo-info-bubble" onclick="this.querySelector('.photo-text-desc').classList.toggle('show')"><div>无图片</div><div class="photo-text-desc">${msg.content.replace('ST_PHOTO_TEXT:', '').trim()}</div></div>`; bubble.classList.add('has-image');
                } else if (msg.content.startsWith('ST_TRANSFER:')) {
                    try { const data = JSON.parse(msg.content.replace('ST_TRANSFER:', '').trim()); bubble.innerHTML = quoteHtml + `<div class="transfer-bubble" onclick="viewTransferDetail(${realIndex})"><div class="transfer-content"><div class="transfer-icon-circle"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></div><div class="transfer-info"><div class="transfer-amount">¥${data.amount}</div><div class="transfer-remark">${data.remark || '转账给您'}</div></div></div><div class="transfer-footer">里世界转账</div></div>`; bubble.classList.add('has-image'); } catch (e) { bubble.innerText = "[转账数据错误]"; }
                } else if (msg.content.startsWith('data:image') || (msg.content.startsWith('http') && msg.content.match(/\.(jpeg|jpg|gif|png)$/i))) {
                    bubble.innerHTML = quoteHtml + `<img src="${msg.content}" class="chat-image">`; bubble.classList.add('has-image');
                } else {
                    bubble.innerHTML = quoteHtml + msg.content.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                }

                if (shouldRenderBubble) {
                    contentWrapper.appendChild(bubble);
                    if (msg.role === 'user') {
                        avatar.src = userAvatar || '';
                        row.appendChild(contentWrapper);
                        row.appendChild(avatar);
                    } else {
                        avatar.src = charAvatar || '';
                        avatar.onclick = () => showCharacterMind();
                        row.appendChild(avatar);
                        row.appendChild(contentWrapper);
                    }
                    container.appendChild(row);
                }
            });
            
            // 只有当不是加载历史时，才自动滚动到底部
            if (!isHistoryLoad) {
                container.scrollTop = container.scrollHeight;
            }
        }

        // --- 引用功能逻辑 ---
function handleQuote() {
    const session = chatSessions.find(s => s.id === currentChatSessionId);
    
    // 确保索引有效
    if (session && currentLongPressMsgIndex >= 0 && currentLongPressMsgIndex < session.messages.length) {
        
        // 重置当前引用，防止污染
        currentQuote = null;

        const msg = session.messages[currentLongPressMsgIndex];
        let text = String(msg.content); // 强制转换为字符串副本
        
        // 修改：不再将特殊消息替换为文本，而是保留原始内容供渲染时解析
        // if (text.startsWith('ST_') || text.startsWith('data:')) text = '[非文本消息]';
        
        // 获取名字
        let name = "未知";
        if (msg.role === 'user') {
            name = dataStore.user[session.userIndex].name;
        } else {
            name = dataStore.character[session.charIndex].name;
        }

        currentQuote = {
            content: text,
            name: name,
            role: msg.role
        };

        // 修改输入框提示
        const input = document.getElementById('chat-input-box');
        input.placeholder = `正在引用 ${name}...`;
        input.focus();
        
        // 显示取消引用按钮
        document.getElementById('cancel-quote-btn').style.display = 'flex';
    }
    hideContextMenu();
}

        // --- 编辑功能逻辑 (新增) ---
        function handleEdit() {
            const session = chatSessions.find(s => s.id === currentChatSessionId);
            // 确保索引有效
            if (session && currentLongPressMsgIndex >= 0 && currentLongPressMsgIndex < session.messages.length) {
                const msg = session.messages[currentLongPressMsgIndex];
                
                // 检查是否是特殊消息（图片/语音等），如果是则提示无法编辑文本
                if (msg.content.startsWith('ST_') || msg.content.startsWith('data:')) {
                    alert("特殊消息（图片/语音/转账等）无法直接编辑文本");
                    hideContextMenu();
                    return;
                }

                // 将内容填充到输入框
                const input = document.getElementById('chat-input-box');
                input.value = msg.content;
                input.focus();
                
                // 设置编辑状态
                isEditingMessage = true;
                editingMessageIndex = currentLongPressMsgIndex;
                
                // 视觉提示（可选，改变输入框边框颜色提示正在编辑）
                input.style.border = "1px solid var(--edit-color)";
            }
            hideContextMenu();
        }

function cancelQuote() {
    currentQuote = null;
    document.getElementById('chat-input-box').placeholder = "";
    // 隐藏取消引用按钮
    document.getElementById('cancel-quote-btn').style.display = 'none';
}

        // --- 撤回功能逻辑 ---
        function handleRecall() {
            const session = chatSessions.find(s => s.id === currentChatSessionId);
            if (session && currentLongPressMsgIndex >= 0) {
                const msg = session.messages[currentLongPressMsgIndex];
                
                // 1. 禁止撤回转账
                if (msg.content.startsWith('ST_TRANSFER:')) {
                    alert('转账信息不可撤回');
                    hideContextMenu();
                    return;
                }

                // 2. 保存原始内容 (保存真实内容，不再简化)
                msg.originalContent = msg.content;
                
                msg.isRecalled = true;
                msg.content = "RECALLED"; // 覆盖内容防止被AI读取到
                
                // 更新最后一条消息显示
                if (session.messages.length > 0) {
                    const last = session.messages[session.messages.length - 1];
                    session.lastMessage = last.isRecalled ? '[撤回消息]' : (last.content.startsWith('ST_') ? '[特殊消息]' : last.content);
                }

                saveToDB('chatSessions', chatSessions);
                renderMessages(session.messages);
            }
            hideContextMenu();
        }

        function viewRecalledMessage(index) {
            const session = chatSessions.find(s => s.id === currentChatSessionId);
            if (session) {
                const msg = session.messages[index];
                const contentDiv = document.getElementById('recall-view-content');
                const raw = msg.originalContent || "";
                
                let displayHTML = "";

                if (raw.startsWith('ST_EMOJI:')) {
                    // 表情包：显示原图
                    const parts = raw.split(':::');
                    const url = parts[1];
                    displayHTML = `<img src="${url}" style="max-width: 100%; border-radius: 8px;">`;
                } else if (raw.startsWith('ST_EMOJI_DESC:')) {
                     const desc = raw.replace('ST_EMOJI_DESC:', '');
                     const found = customEmojis.find(e => e.desc === desc);
                     if (found) {
                         displayHTML = `<img src="${found.url}" style="max-width: 100%; border-radius: 8px;">`;
                     } else {
                         displayHTML = `[表情包: ${desc}] (原图丢失)`;
                     }
                } else if (raw.startsWith('data:image')) {
                    // 本地图片：显示原图
                    displayHTML = `<img src="${raw}" style="max-width: 100%; border-radius: 8px;">`;
                } else if (raw.startsWith('ST_VOICE:')) {
                    // 语音：【语音 秒数】语音内容
                    const parts = raw.replace('ST_VOICE:', '').split(':::');
                    const duration = parts[0];
                    const text = parts[1] || '';
                    displayHTML = `【语音 ${duration}】${text}`;
                } else if (raw.startsWith('ST_PHOTO_TEXT:')) {
                    // 照片描述：【照片】照片内容
                    const desc = raw.replace('ST_PHOTO_TEXT:', '');
                    displayHTML = `【照片】${desc}`;
                } else if (raw.startsWith('ST_TRANSFER:')) {
                    // 转账：此处一般不撤回，但以防万一
                    try {
                        const data = JSON.parse(raw.replace('ST_TRANSFER:', ''));
                        displayHTML = `【里世界转账】${data.amount}`;
                    } catch(e) { displayHTML = `【里世界转账】`; }
                } else {
                    // 普通文本
                    displayHTML = raw.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                }

                contentDiv.innerHTML = displayHTML;
                document.getElementById('recall-view-overlay').classList.add('show');
            }
        }

        // --- 多选功能逻辑 ---
        function handleMultiSelect() {
            isMultiSelectMode = true;
            hideContextMenu();
            
            // 切换底部栏
            document.getElementById('chat-footer').style.display = 'none';
            document.getElementById('toolbar-multiselect').style.display = 'flex';
            
            // 重新渲染以启用点击选择
            const session = chatSessions.find(s => s.id === currentChatSessionId);
            renderMessages(session.messages);
        }

        function cancelMultiSelect() {
            isMultiSelectMode = false;
            // 恢复底部栏
            document.getElementById('chat-footer').style.display = 'flex';
            document.getElementById('toolbar-multiselect').style.display = 'none';
            
            // 清除选中状态
            const session = chatSessions.find(s => s.id === currentChatSessionId);
            session.messages.forEach(m => m.selected = false);
            renderMessages(session.messages);
        }

        function deleteSelectedMessages() {
            if(confirm("确定删除选中的消息吗？")) {
                const session = chatSessions.find(s => s.id === currentChatSessionId);
                session.messages = session.messages.filter(m => !m.selected);
                
                // 更新最后一条消息
                if (session.messages.length > 0) {
                    const last = session.messages[session.messages.length - 1];
                    session.lastMessage = last.isRecalled ? '[撤回消息]' : (last.content.startsWith('ST_') ? '[特殊消息]' : last.content);
                } else {
                    session.lastMessage = '';
                }

                saveToDB('chatSessions', chatSessions);
                cancelMultiSelect();
            }
        }

        // --- 长按菜单逻辑 ---
        function showContextMenu(e, index, role) {
            e.preventDefault();
            currentLongPressMsgIndex = index;
            const menu = document.getElementById('context-menu');
            menu.innerHTML = '';

            // 通用选项：引用
            const quoteBtn = document.createElement('div');
            quoteBtn.className = 'context-menu-item';
            quoteBtn.innerText = '引用';
            quoteBtn.onclick = handleQuote;
            menu.appendChild(quoteBtn);

            // 新增：编辑选项
            const editBtn = document.createElement('div');
            editBtn.className = 'context-menu-item';
            editBtn.innerText = '编辑';
            // editBtn.style.color = 'var(--edit-color)'; // 已移除颜色设置，保持默认白色
            editBtn.onclick = handleEdit;
            menu.appendChild(editBtn);

            // 用户特有：撤回
            if (role === 'user') {
                const recallBtn = document.createElement('div');
                recallBtn.className = 'context-menu-item';
                recallBtn.innerText = '撤回';
                recallBtn.onclick = handleRecall;
                menu.appendChild(recallBtn);
            }

            // 通用选项：删除
            const deleteBtn = document.createElement('div');
            deleteBtn.className = 'context-menu-item danger';
            deleteBtn.innerText = '删除';
            deleteBtn.onclick = handleDelete;
            menu.appendChild(deleteBtn);

            // 通用选项：多选
            const multiBtn = document.createElement('div');
            multiBtn.className = 'context-menu-item';
            multiBtn.innerText = '多选';
            multiBtn.onclick = handleMultiSelect;
            menu.appendChild(multiBtn);

            // 定位菜单 (修改为跟随气泡并自动翻转)
            const bubble = e.target.closest('.chat-bubble');
            if (!bubble) return;

            const rect = bubble.getBoundingClientRect();
            const menuWidth = 120; // 菜单预估宽度
            // 临时显示以获取高度，或者预估高度 (4个选项约180px)
            const menuHeight = 180; 
            
            let menuX, menuY;

            // 垂直居中：气泡顶部 + (气泡高度/2) - (菜单高度/2)
            menuY = rect.top + (rect.height / 2) - (menuHeight / 2);
            
            // 防止垂直溢出屏幕
            if (menuY < 10) menuY = 10;
            if (menuY + menuHeight > window.innerHeight) menuY = window.innerHeight - menuHeight - 10;

            // 水平定位逻辑
            if (role === 'user') {
                // 用户气泡在右侧，菜单默认显示在左侧
                menuX = rect.left - menuWidth - 10; // 10px 间距
                // 如果左侧空间不足 (超出屏幕左边缘)，则翻转到右侧 (覆盖气泡或在气泡内)
                if (menuX < 5) {
                    menuX = rect.left + 10; // 翻转到气泡内部左侧
                }
            } else {
                // 角色气泡在左侧，菜单默认显示在右侧
                menuX = rect.right + 10; // 10px 间距
                // 如果右侧空间不足 (超出屏幕右边缘)，则翻转到左侧
                if (menuX + menuWidth > window.innerWidth) {
                    menuX = rect.right - menuWidth - 10; // 翻转到气泡内部右侧
                }
            }

            menu.style.left = menuX + 'px';
            menu.style.top = menuY + 'px';
            menu.classList.add('show');
        }

        function hideContextMenu() {
            document.getElementById('context-menu').classList.remove('show');
        }

        function handleDelete() {
            const session = chatSessions.find(s => s.id === currentChatSessionId);
            if (session && currentLongPressMsgIndex >= 0) {
                session.messages.splice(currentLongPressMsgIndex, 1);
                // 更新最后一条消息
                if (session.messages.length > 0) {
                    const last = session.messages[session.messages.length - 1];
                    session.lastMessage = last.isRecalled ? '[撤回消息]' : (last.content.startsWith('ST_') ? '[特殊消息]' : last.content);
                } else {
                    session.lastMessage = '';
                }
                saveToDB('chatSessions', chatSessions);
                renderMessages(session.messages);
            }
            hideContextMenu();
        }


        async function sendMessage() {
            const input = document.getElementById('chat-input-box');
            const text = input.value.trim();
            if (!text) return;

            let session = chatSessions.find(s => s.id === currentChatSessionId);
            if (!session) {
                const [charIdx, userIdx] = currentChatSessionId.split('_');
                session = {
                    id: currentChatSessionId,
                    charIndex: parseInt(charIdx),
                    userIndex: parseInt(userIdx),
                    messages: [],
                    lastMessage: text,
                    timestamp: Date.now(),
                    pinned: false,
                    settings: { memory: 20, summaries: [], remark: '', worldbookIds: [] } 
                };
                chatSessions.push(session);
            } else {
                session.lastMessage = text;
                session.timestamp = Date.now();
            }

            // 判断是编辑模式还是发送模式
            if (isEditingMessage && editingMessageIndex > -1) {
                // --- 编辑模式保存逻辑 ---
                if (editingMessageIndex < session.messages.length) {
                    session.messages[editingMessageIndex].content = text;
                    // 如果编辑的是最后一条消息，更新列表显示的预览
                    if (editingMessageIndex === session.messages.length - 1) {
                        session.lastMessage = text;
                    }
                }
                
                // 重置编辑状态
                isEditingMessage = false;
                editingMessageIndex = -1;
                input.style.border = "none"; 
                
            } else {
                // --- 原有的发送新消息逻辑 ---
                const msgObj = { role: 'user', content: text, timestamp: Date.now() };
                
// 如果有引用
if (currentQuote) {
    msgObj.quote = { ...currentQuote };
    cancelQuote(); // 清除引用状态（会自动隐藏按钮）
}

                session.messages.push(msgObj);
            }
            
            // 公共后续处理
            saveToDB('chatSessions', chatSessions);
            renderMessages(session.messages); 
            
            // 清空输入框 (不再设置 placeholder)
            input.value = '';
            
            renderChatList();
        }

        // --- 接收按钮逻辑 ---
        function triggerReceive() {
            let session = chatSessions.find(s => s.id === currentChatSessionId);
            if (!session) {
                if (currentChatSessionId) {
                    const [charIdx, userIdx] = currentChatSessionId.split('_');
                    session = {
                        id: currentChatSessionId,
                        charIndex: parseInt(charIdx),
                        userIndex: parseInt(userIdx),
                        messages: [],
                        lastMessage: '',
                        timestamp: Date.now(),
                        pinned: false,
                        settings: { memory: 20, summaries: [], remark: '', worldbookIds: [] } 
                    };
                    chatSessions.push(session);
                } else {
                    return; 
                }
            }
            getAIResponse(session);
        }

        // --- 工具栏逻辑 ---
        // 修改：切换工具栏时，同时调整聊天记录区域的样式
        function toggleToolbar() {
            const footer = document.querySelector('.chat-footer');
            const panel = document.getElementById('chat-toolbar');
            const messages = document.getElementById('chat-messages');

            isToolbarOpen = !isToolbarOpen;
            
            // 移除所有内联样式干扰
            messages.style.paddingBottom = "";
            messages.style.bottom = "";

            if (isToolbarOpen) {
                footer.classList.add('toolbar-open');
                panel.classList.add('open');
                messages.classList.add('shifted');
                
                // 强制滚动到底部 (分两次，确保动画完成后修正)
                messages.scrollTop = messages.scrollHeight;
                setTimeout(() => { messages.scrollTop = messages.scrollHeight; }, 250);
                
            } else {
                footer.classList.remove('toolbar-open');
                panel.classList.remove('open');
                messages.classList.remove('shifted');
                
                // 恢复视图
                document.getElementById('toolbar-main').style.display = 'grid';
                document.getElementById('toolbar-emoji').style.display = 'none';
                document.getElementById('toolbar-voice').style.display = 'none';
                document.getElementById('toolbar-photo').style.display = 'none';
                document.getElementById('toolbar-transfer').style.display = 'none';
            }
        }

        function closeToolbar() {
            if (isToolbarOpen) {
                toggleToolbar();
            }
        }

        function toolbarAction(action) {
            if (action === 'regenerate') {
                let session = chatSessions.find(s => s.id === currentChatSessionId);
                if (session && session.messages.length > 0) {
                    // 删除最后一段连续的 assistant 消息
                    while (session.messages.length > 0 && session.messages[session.messages.length - 1].role === 'assistant') {
                        session.messages.pop();
                    }
                    
                    session.lastMessage = session.messages.length > 0 ? session.messages[session.messages.length - 1].content : '';
                    saveToDB('chatSessions', chatSessions);
                    renderMessages(session.messages);
                    renderChatList();
                    
                    getAIResponse(session);
                }
                closeToolbar();
            } else if (action === 'continue') {
                let session = chatSessions.find(s => s.id === currentChatSessionId);
                if (session) {
                    getAIResponse(session);
                }
                closeToolbar();
            } else if (action === 'emoji') {
                // 切换到表情包面板
                document.getElementById('toolbar-main').style.display = 'none';
                document.getElementById('toolbar-emoji').style.display = 'flex';
                document.getElementById('toolbar-voice').style.display = 'none';
                document.getElementById('toolbar-photo').style.display = 'none';
                document.getElementById('toolbar-transfer').style.display = 'none';
                // 默认显示列表视图
                document.getElementById('emoji-view-list').style.display = 'flex';
                document.getElementById('emoji-view-add').style.display = 'none';
                renderEmojiPanel();
            } else if (action === 'voice') {
                // 切换到语音面板
                document.getElementById('toolbar-main').style.display = 'none';
                document.getElementById('toolbar-emoji').style.display = 'none';
                document.getElementById('toolbar-voice').style.display = 'flex';
                document.getElementById('toolbar-photo').style.display = 'none';
                document.getElementById('toolbar-transfer').style.display = 'none';
                document.getElementById('voice-input').value = '';
            } else if (action === 'photo') {
                // 切换到照片面板
                document.getElementById('toolbar-main').style.display = 'none';
                document.getElementById('toolbar-emoji').style.display = 'none';
                document.getElementById('toolbar-voice').style.display = 'none';
                document.getElementById('toolbar-photo').style.display = 'flex';
                document.getElementById('toolbar-transfer').style.display = 'none';
                document.getElementById('photo-input').value = '';
                document.getElementById('photo-preview-area').innerHTML = '<span class="photo-preview-placeholder">本地上传预览</span>';
                tempPhotoData = null;
            } else if (action === 'transfer') {
                // 切换到转账面板
                document.getElementById('toolbar-main').style.display = 'none';
                document.getElementById('toolbar-emoji').style.display = 'none';
                document.getElementById('toolbar-voice').style.display = 'none';
                document.getElementById('toolbar-photo').style.display = 'none';
                document.getElementById('toolbar-transfer').style.display = 'flex';
                document.getElementById('transfer-amount').value = '';
                document.getElementById('transfer-remark').value = '';
            } else {
                alert('功能开发中...');
            }
        }

        // --- 语音功能逻辑 ---
        function sendVoice() {
            const text = document.getElementById('voice-input').value.trim();
            if (!text) return;

            let session = chatSessions.find(s => s.id === currentChatSessionId);
            if (!session) return;

            // 模拟计算秒数：最少2秒，最多60秒，根据字数估算
            const duration = Math.max(2, Math.min(60, Math.ceil(text.length * 0.4)));
            
            // 协议：ST_VOICE:秒数:::文本 (使用 ::: 分隔符)
            const content = `ST_VOICE:${duration}:::${text}`;
            
            session.messages.push({ role: 'user', content: content, timestamp: Date.now() });
            session.lastMessage = '[语音]';
            session.timestamp = Date.now();
            
            saveToDB('chatSessions', chatSessions);
            renderMessages(session.messages);
            renderChatList();
            closeToolbar();
        }

        function closeVoicePanel() {
            document.getElementById('toolbar-main').style.display = 'grid';
            document.getElementById('toolbar-voice').style.display = 'none';
        }

        // --- 照片功能逻辑 ---
        function previewPhoto(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    tempPhotoData = e.target.result;
                    document.getElementById('photo-preview-area').innerHTML = `<img src="${tempPhotoData}" class="photo-preview-img">`;
                };
                reader.readAsDataURL(file);
            }
            event.target.value = '';
        }

        function sendPhoto() {
            const text = document.getElementById('photo-input').value.trim();
            let session = chatSessions.find(s => s.id === currentChatSessionId);
            if (!session) return;

            if (tempPhotoData) {
                // 发送本地图片
                session.messages.push({ role: 'user', content: tempPhotoData, timestamp: Date.now() });
                session.lastMessage = '[图片]';
            } else if (text) {
                // 发送文本描述的照片信息
                const content = `ST_PHOTO_TEXT:${text}`;
                session.messages.push({ role: 'user', content: content, timestamp: Date.now() });
                session.lastMessage = '[照片]';
            } else {
                alert("请输入照片内容或上传本地照片");
                return;
            }

            session.timestamp = Date.now();
            saveToDB('chatSessions', chatSessions);
            renderMessages(session.messages);
            renderChatList();
            closeToolbar();
        }

        function closePhotoPanel() {
            document.getElementById('toolbar-main').style.display = 'grid';
            document.getElementById('toolbar-photo').style.display = 'none';
        }

        // --- 转账功能逻辑 ---
        function sendTransfer() {
            const amount = document.getElementById('transfer-amount').value.trim();
            const remark = document.getElementById('transfer-remark').value.trim();
            
            if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
                alert("请输入有效的转账金额");
                return;
            }

            let session = chatSessions.find(s => s.id === currentChatSessionId);
            if (!session) return;

            // 构造转账数据
            const transferData = {
                amount: parseFloat(amount).toFixed(2),
                remark: remark,
                status: 'pending', // pending, received, returned
                timestamp: Date.now(),
                actionTime: null // 收款或退还时间
            };

            const content = `ST_TRANSFER:${JSON.stringify(transferData)}`;
            
            session.messages.push({ role: 'user', content: content, timestamp: Date.now() });
            session.lastMessage = '[转账]';
            session.timestamp = Date.now();
            
            saveToDB('chatSessions', chatSessions);
            renderMessages(session.messages);
            renderChatList();
            closeToolbar();
        }

        function closeTransferPanel() {
            document.getElementById('toolbar-main').style.display = 'grid';
            document.getElementById('toolbar-transfer').style.display = 'none';
        }

        function viewTransferDetail(msgIndex) {
            let session = chatSessions.find(s => s.id === currentChatSessionId);
            if (!session) return;

            const msg = session.messages[msgIndex];
            if (!msg.content.startsWith('ST_TRANSFER:')) return;

            const data = JSON.parse(msg.content.replace('ST_TRANSFER:', ''));
            // 判断是谁发的转账
            const isUserSender = msg.role === 'user';
            const sender = isUserSender ? dataStore.user[session.userIndex] : dataStore.character[session.charIndex];
            
            // 格式化时间
            const formatDate = (ts) => {
                const date = new Date(ts);
                return `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2,'0')}-${date.getDate().toString().padStart(2,'0')} ${date.getHours().toString().padStart(2,'0')}:${date.getMinutes().toString().padStart(2,'0')}:${date.getSeconds().toString().padStart(2,'0')}`;
            };

            let statusText = "";
            let extraInfo = "";

            if (data.status === 'pending') {
                statusText = "待接收";
            } else if (data.status === 'received') {
                statusText = "已接收";
                // 模拟收款时间，如果没有记录则用转账时间+1分钟
                const recvTime = data.actionTime ? formatDate(data.actionTime) : formatDate(data.timestamp + 60000);
                extraInfo = `<div class="meta-row"><span>收款时间</span><span>${recvTime}</span></div>`;
            } else if (data.status === 'returned') {
                statusText = "已退还";
                // 模拟退还时间，如果没有记录则用转账时间+24小时
                const retTime = data.actionTime ? formatDate(data.actionTime) : formatDate(data.timestamp + 86400000);
                extraInfo = `<div class="meta-row"><span>退还时间</span><span>${retTime}</span></div>`;
            }

            // 修改：转账时间优先使用 originalTimestamp
            const transferTime = data.originalTimestamp || data.timestamp;

            const html = `
                <img src="${sender.avatar || ''}" class="transfer-detail-avatar" onerror="this.style.backgroundColor='var(--input-bg)'">
                <div class="transfer-detail-name">${sender.name}</div>
                <div class="transfer-detail-status">${statusText}</div>
                <div class="transfer-detail-amount">¥${data.amount}</div>
                <div class="transfer-detail-meta">
                    <div class="meta-row"><span>转账说明</span><span>${data.remark || '无'}</span></div>
                    <div class="meta-row"><span>转账时间</span><span>${formatDate(transferTime)}</span></div>
                    ${extraInfo}
                </div>
            `;

            document.getElementById('transfer-detail-content').innerHTML = html;
            
            // 检查是否需要添加操作按钮：如果是角色发送且状态为待接收，则用户可以操作
            const btnsContainer = document.getElementById('transfer-detail-btns');
            
            // 修改：统一按钮布局，确保大小一致
            let buttonsHtml = '';
            if (!isUserSender && data.status === 'pending') {
                buttonsHtml += `<button class="modal-btn" style="background-color: #000000; color: white;" onclick="userHandleTransfer(${msgIndex}, 'receive')">接收</button>`;
                buttonsHtml += `<button class="modal-btn" style="background-color: #999999; color: white;" onclick="userHandleTransfer(${msgIndex}, 'return')">退还</button>`;
            }
            buttonsHtml += `<button class="modal-btn" style="background-color: white; color: black; border: 1px solid #ddd;" onclick="document.getElementById('transfer-detail-overlay').classList.remove('show')">关闭</button>`;
            
            btnsContainer.innerHTML = buttonsHtml;
            document.getElementById('transfer-detail-overlay').classList.add('show');
        }

        // 新增：用户处理转账（接收/退还）
        function userHandleTransfer(msgIndex, action) {
            let session = chatSessions.find(s => s.id === currentChatSessionId);
            if (!session) return;

            const msg = session.messages[msgIndex];
            if (!msg.content.startsWith('ST_TRANSFER:')) return;

            const data = JSON.parse(msg.content.replace('ST_TRANSFER:', ''));
            
            // 更新原消息状态
            data.status = action === 'receive' ? 'received' : 'returned';
            data.remark = action === 'receive' ? '已被接收' : '已被退还'; // 修改：明确更新为已被接收/已被退还
            data.actionTime = Date.now();
            msg.content = `ST_TRANSFER:${JSON.stringify(data)}`;

            // 发送一条新的回执消息（由用户发出）
            const receiptData = {
                amount: data.amount,
                remark: action === 'receive' ? '已接收' : '已退还',
                status: action === 'receive' ? 'received' : 'returned',
                timestamp: Date.now(),
                actionTime: Date.now(),
                originalTimestamp: data.timestamp // 修改：携带原始转账时间
            };
            
            session.messages.push({ role: 'user', content: `ST_TRANSFER:${JSON.stringify(receiptData)}`, timestamp: Date.now() });
            session.lastMessage = '[转账]';
            session.timestamp = Date.now();

            saveToDB('chatSessions', chatSessions);
            renderMessages(session.messages);
            renderChatList();
            document.getElementById('transfer-detail-overlay').classList.remove('show');
        }

        // --- 表情包功能逻辑 ---
        function renderEmojiPanel() {
            const container = document.getElementById('emoji-grid-container');
            container.innerHTML = '';
            
            customEmojis.forEach((item, index) => {
                const img = document.createElement('img');
                img.src = item.url;
                img.className = 'emoji-item';
                if(isEmojiDeleteMode) img.classList.add('deleting');
                
                img.onclick = () => {
                    if (isEmojiDeleteMode) {
                        deleteEmoji(index);
                    } else {
                        sendEmoji(item);
                    }
                };
                container.appendChild(img);
            });
        }

        function openAddEmojiPanel() {
            document.getElementById('emoji-view-list').style.display = 'none';
            document.getElementById('emoji-view-add').style.display = 'flex';
            document.getElementById('emoji-add-input').value = '';
        }

        function cancelAddEmoji() {
            document.getElementById('emoji-view-list').style.display = 'flex';
            document.getElementById('emoji-view-add').style.display = 'none';
        }

        function saveAddedEmojis() {
            const text = document.getElementById('emoji-add-input').value;
            if (!text.trim()) return;

            const lines = text.split('\n');
            let addedCount = 0;

            lines.forEach(line => {
                line = line.trim();
                if (!line) return;

                // 匹配三种格式：描述:URL, 描述：URL, 描述 URL
                // 正则：以非空白字符开头，中间是冒号或空格，后面是http开头
                const match = line.match(/^(.+?)[:：\s]+(https?:\/\/.+)$/);
                if (match) {
                    const desc = match[1].trim();
                    const url = match[2].trim();
                    customEmojis.push({ url: url, desc: desc });
                    addedCount++;
                }
            });

            if (addedCount > 0) {
                saveToDB('customEmojis', customEmojis);
                renderEmojiPanel();
                cancelAddEmoji();
                alert(`成功添加 ${addedCount} 个表情包`);
            } else {
                alert("未识别到有效格式。请使用：描述:URL");
            }
        }

        function uploadEmoji(event) {
            const file = event.target.files[0];
            if (file) {
                // 弹出输入框获取描述
                const desc = prompt("请输入该表情包的文字描述（例如：开心）：");
                if (desc) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        customEmojis.push({ url: e.target.result, desc: desc });
                        saveToDB('customEmojis', customEmojis);
                        renderEmojiPanel();
                    };
                    reader.readAsDataURL(file);
                }
            }
            event.target.value = '';
        }

        function toggleDeleteEmoji() {
            isEmojiDeleteMode = !isEmojiDeleteMode;
            const btn = document.getElementById('emoji-delete-toggle');
            btn.innerText = isEmojiDeleteMode ? "删除模式: 开" : "删除模式: 关";
            if (isEmojiDeleteMode) btn.classList.add('delete-mode');
            else btn.classList.remove('delete-mode');
            renderEmojiPanel();
        }

        function deleteEmoji(index) {
            if(confirm("确定删除这个表情包吗？")) {
                customEmojis.splice(index, 1);
                saveToDB('customEmojis', customEmojis);
                renderEmojiPanel();
            }
        }

        function closeEmojiPanel() {
            document.getElementById('toolbar-main').style.display = 'grid';
            document.getElementById('toolbar-emoji').style.display = 'none';
            isEmojiDeleteMode = false;
            document.getElementById('emoji-delete-toggle').innerText = "删除模式: 关";
            document.getElementById('emoji-delete-toggle').classList.remove('delete-mode');
        }

        function sendEmoji(item) {
            let session = chatSessions.find(s => s.id === currentChatSessionId);
            if (!session) return; 

            // 使用特定协议存储表情包：ST_EMOJI:描述:::URL (分隔符改为 :::)
            const content = `ST_EMOJI:${item.desc}:::${item.url}`;
            
            session.messages.push({ role: 'user', content: content, timestamp: Date.now() });
            session.lastMessage = '[表情包]';
            session.timestamp = Date.now();
            
            saveToDB('chatSessions', chatSessions);
            renderMessages(session.messages);
            renderChatList();
            closeToolbar();
        }

        // --- 手动总结逻辑 (修改为列表) ---
        async function triggerManualSummary() {
            const session = chatSessions.find(s => s.id === currentChatSessionId);
            if (!session) return;

            const apiUrl = document.getElementById('api-url').value.trim();
            const apiKey = document.getElementById('api-key').value.trim();
            const apiModel = document.getElementById('api-model').value.trim();

            if (!apiUrl || !apiKey) {
                alert("请先配置API");
                return;
            }

            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = "生成中...";
            btn.disabled = true;

            try {
                // --- 1. 计算总结范围 ---
                const totalMsgs = session.messages.length;
                let startIdx = 0;
                
                // 查找上一条总结记录的结束位置
                if (session.settings.summaries && session.settings.summaries.length > 0) {
                    const lastSummary = session.settings.summaries[session.settings.summaries.length - 1];
                    if (lastSummary.endIndex) {
                        startIdx = lastSummary.endIndex;
                    }
                }

                // 如果没有新消息，提示用户
                if (startIdx >= totalMsgs) {
                    alert("没有新的消息需要总结");
                    return;
                }

                // 本次总结范围：上一条结束位置 ~ 当前最新位置
                // 显示范围是从 1 开始计数，所以是 (startIdx + 1) ~ totalMsgs
                const rangeStr = `${startIdx + 1}-${totalMsgs}`;
                
                // 截取需要总结的消息片段
                const msgsToSummarize = session.messages.slice(startIdx);

                const historyText = msgsToSummarize.map(m => {
                    let content = m.content;
                    if (content.startsWith('ST_EMOJI:')) {
                        const parts = content.split(':::'); 
                        content = `[发送了表情包：${parts[0].replace('ST_EMOJI:', '')}]`;
                    } else if (content.startsWith('ST_VOICE:')) {
                        const parts = content.replace('ST_VOICE:', '').split(':::');
                        content = `[发送了一条语音消息：${parts[1]}]`;
                    } else if (content.startsWith('ST_PHOTO_TEXT:')) {
                        content = `[发送了一张照片：${content.replace('ST_PHOTO_TEXT:', '')}]`;
                    } else if (content.startsWith('data:image')) {
                        content = `[发送了一张照片]`;
                    } else if (content.startsWith('ST_TRANSFER:')) {
                        const data = JSON.parse(content.replace('ST_TRANSFER:', ''));
                        content = `[发送了一笔转账，金额：${data.amount}，备注：${data.remark}]`;
                    }
                    return `${m.role}: ${content}`;
                }).join('\n');
                
                const charName = dataStore.character[session.charIndex].name;
                const userName = dataStore.user[session.userIndex].name;

                let prompt = "";
                const customPrompt = session.settings.summaryPrompt;

                // --- 计算时间跨度 (第一条消息 - 最后一条消息) ---
                let timeSpanStr = "未知时间";
                if (msgsToSummarize.length > 0) {
                    const firstMsg = msgsToSummarize[0];
                    const lastMsg = msgsToSummarize[msgsToSummarize.length - 1];
                    
                    const formatTime = (ts) => {
                        const d = new Date(ts);
                        return `${d.getFullYear()}年${d.getMonth()+1}月${d.getDate()}日 ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}:${d.getSeconds().toString().padStart(2,'0')}`;
                    };
                    
                    if (firstMsg.timestamp && lastMsg.timestamp) {
                        timeSpanStr = `${formatTime(firstMsg.timestamp)} 至 ${formatTime(lastMsg.timestamp)}`;
                    }
                }

                // 构造 Prompt
                if (customPrompt && customPrompt.trim()) {
                    let processedPrompt = customPrompt.replace(/\{\{user\}\}/gi, userName).replace(/\{\{char\}\}/gi, charName);
                    // 自定义 Prompt 依然保留 historyText，但不强制格式
                    prompt = `${processedPrompt}\n\nChat History:\n${historyText}`;
                } else {
                    prompt = `Please summarize the following chat history between ${charName} (assistant) and ${userName} (user) in the third person.
You MUST output in Simplified Chinese (简体中文).
Strictly follow this format for the output:
1. 具体时间: ${timeSpanStr}
2. 具体事件: [List key events]
3. 核心事件: [The main topic]
4. 待办事项: [Any pending actions]

Chat History:
${historyText}`;
                }

                let fetchUrl = '';
                if (apiUrl.includes('googleapis.com')) {
                    const baseUrl = apiUrl.endsWith('/') ? apiUrl.slice(0, -1) : apiUrl;
                    fetchUrl = baseUrl.includes('/models') ? `${baseUrl}?key=${apiKey}` : `${baseUrl}/chat/completions`;
                } else {
                    const baseUrl = apiUrl.endsWith('/') ? apiUrl.slice(0, -1) : apiUrl;
                    fetchUrl = baseUrl.endsWith('/v1') ? `${baseUrl}/chat/completions` : (baseUrl.endsWith('/chat/completions') ? baseUrl : `${baseUrl}/v1/chat/completions`);
                }

                const response = await fetch(fetchUrl, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: apiModel || 'gpt-3.5-turbo',
                        messages: [{ role: "user", content: prompt }],
                        temperature: 0.5
                    })
                });

                if (!response.ok) throw new Error(`API Error: ${response.status}`);

                const data = await response.json();
                let summaryContent = data.choices[0].message.content;

                // 如果使用了默认 Prompt，确保时间格式正确（防止AI没按要求输出）
                // 如果是自定义 Prompt，则由用户自己控制，或者AI自由发挥
                if (!customPrompt) {
                    // 简单的检查，如果AI没带时间，手动加上（可选）
                }

                // 新增总结到列表
                if (!session.settings.summaries) session.settings.summaries = [];
                session.settings.summaries.push({
                    id: Date.now().toString(),
                    content: summaryContent,
                    timestamp: Date.now(),
                    endIndex: totalMsgs // 记录本次总结结束时的消息总数
                });

                saveToDB('chatSessions', chatSessions);
                renderSummaryList();
                alert(`总结生成完毕 (范围: ${rangeStr})`);

            } catch (error) {
                console.error(error);
                alert("总结失败: " + error.message);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        async function getAIResponse(session) {
            const apiUrl = document.getElementById('api-url').value.trim();
            const apiKey = document.getElementById('api-key').value.trim();
            const apiModel = document.getElementById('api-model').value.trim();

            if (!apiUrl || !apiKey) return;

            const chatTitle = document.getElementById('chat-title');
            const char = dataStore.character[session.charIndex];
            const originalTitle = session.settings.remark ? session.settings.remark : char.name;
            chatTitle.innerText = "正在输入中…";

            try {
                const user = dataStore.user[session.userIndex];
                
                // --- 1. 占位符替换逻辑 ---
                const replacePlaceholders = (text) => {
                    if (!text) return "";
                    return text.replace(/\{\{user\}\}/gi, user.name).replace(/\{\{char\}\}/gi, char.name);
                };

                const processedCharDesc = replacePlaceholders(char.desc);
                const processedUserDesc = replacePlaceholders(user.desc);
                const processedJailbreak = replacePlaceholders(document.getElementById('api-jailbreak').value);

                // --- 2. 智能时间感知逻辑 (简化修复版) ---
                const now = new Date();
                const timeString = `${now.getFullYear()}年${now.getMonth()+1}月${now.getDate()}日 ${now.getHours()}时${now.getMinutes()}分${now.getSeconds()}秒`;
                
                let timeDiffMsg = "";
                let longTimeNoSee = false;
                let isUserReplyDelay = false; 

                if (session.messages.length > 0) {
                    const len = session.messages.length;
                    const lastMsg = session.messages[len - 1];
                    let diffMs = 0;

                    if (lastMsg.role === 'user') {
                        // 用户刚发了消息，或者用户发了消息后过了一会点接收
                        // 我们只关心：用户这条消息，距离“上一轮对话结束”隔了多久
                        
                        // 往前找，找到上一条不是用户发的消息（即角色的最后一条）
                        let lastCharMsgIndex = len - 2;
                        while (lastCharMsgIndex >= 0 && session.messages[lastCharMsgIndex].role === 'user') {
                            lastCharMsgIndex--;
                        }

                        if (lastCharMsgIndex >= 0) {
                            const lastCharMsg = session.messages[lastCharMsgIndex];
                            // 计算时间差：用户最新回复的时间 - 角色上一句的时间
                            diffMs = lastMsg.timestamp - lastCharMsg.timestamp;
                            isUserReplyDelay = true; // 这是用户回复的延迟
                        } else {
                            // 如果前面没有角色消息（第一次对话），则没有延迟
                            diffMs = 0;
                        }
                    } else {
                        // 最后一条是角色发的，用户点接收（催更）
                        // 计算现在距离角色上一句话隔了多久
                        diffMs = now.getTime() - lastMsg.timestamp;
                        isUserReplyDelay = false; // 这是角色沉默的时长
                    }
                    
                    // 计算时间文本
                    const diffMins = Math.floor(diffMs / 60000);
                    const diffHours = Math.floor(diffMins / 60);
                    const diffDays = Math.floor(diffHours / 24);
                    
                    if (diffDays > 0) { timeDiffMsg = `${diffDays}天`; longTimeNoSee = true; }
                    else if (diffHours > 0) { timeDiffMsg = `${diffHours}小时`; longTimeNoSee = true; }
                    else if (diffMins > 10) { timeDiffMsg = `${diffMins}分钟`; longTimeNoSee = true; } // 超过10分钟触发
                    else if (diffMins > 0) timeDiffMsg = `${diffMins}分钟`;
                    else timeDiffMsg = "刚刚";
                }

                // ==================== System Prompt 构建 ====================
                let systemContent = "";

// 1. 核心身份与模式设定
systemContent += `[System Note: MODE = ONLINE TEXT CHAT (NOT VOICE/VIDEO CALL)]\n`;
systemContent += `[Important: You are strictly in a TEXT MESSAGING app. You are NOT on a phone call or video call.]\n`;
systemContent += `[CRITICAL CONSTRAINT: DO NOT describe actions, facial expressions, or tone. ONLY output the spoken text/dialogue.]\n`;
systemContent += `[CRITICAL: DO NOT output any thinking process, reasoning, or chain-of-thought. NO phrases like "让我想想", "我觉得", "我认为", "首先...然后...". ONLY output direct dialogue/response.]\n`;
                
systemContent += `[Style Requirement: Mimic casual texting style. Minimize punctuation. Use spaces instead of commas. Avoid periods at the end of sentences unless emphasizing.]\n`;
// 修改：强制分条，严格字数限制
systemContent += `[Structure Requirement: You MUST split your reply into 2-8 separate short messages using '|||'. This is MANDATORY, not optional.]\n`;
systemContent += `[CRITICAL: Each message segment MUST be UNDER 20 Chinese characters. If you need to say more, split it into multiple segments. Example: "好的|||我明白了|||马上去做" instead of "好的我明白了马上去做".]\n`;
systemContent += `[FORBIDDEN: DO NOT output a single long paragraph. DO NOT exceed 20 characters per segment. Violating this will result in system error.]\n`;
systemContent += `[Language: Simplified Chinese (简体中文) ONLY for all output.]\n`;
systemContent += `[Output Format Enforcement: Every response MUST use '|||' to separate messages. Single long messages are STRICTLY PROHIBITED.]\n`;

                // 2. 功能指令 (格式增强)
                systemContent += `\n[System Note: Functional Instructions]\n`;
                // 增强格式保护：要求严格遵守括号格式
                systemContent += `[Format Protection: When sending special content (Emoji/Voice/Photo/Transfer), you MUST strictly follow the bracket format [COMMAND:...] without adding extra text or punctuation inside or outside the brackets.]\n`;
                
                if (customEmojis.length > 0) {
                    const emojiList = customEmojis.map(e => `${e.desc}`).join(', ');
                    // 保留您的修改
                    systemContent += `[You can send emojis, but there's no need to send them every time you reply. If the World Book prohibits or asks you to send them less, you must prioritize following the World Book. To send an emoji, output exactly: [EMOJI:description]. List: ${emojiList}.]\n`;
                }
                systemContent += `[To send voice: [VOICE:text content]. To send photo: [PHOTO:image description]. To transfer money: [TRANSFER:amount:remark].]\n`;
                systemContent += `[To recall last message: [RECALL].]\n`;
                
                const pendingTransfers = session.messages.filter(m => m.role === 'user' && m.content.startsWith('ST_TRANSFER') && m.content.includes('"status":"pending"'));
                if (pendingTransfers.length > 0) {
                    systemContent += `[Pending transfers from user: ${pendingTransfers.length}. Output [TRANSFER:ACCEPT] or [TRANSFER:RETURN] to handle.]\n`;
                }

                // 3. 上下文
                systemContent += `\n[System Note: Context]\n`;
                if (session.settings.summaries && session.settings.summaries.length > 0) {
                    systemContent += `【历史总结】\n`;
                    session.settings.summaries.forEach((s, idx) => {
                         systemContent += `[总结 ${idx+1}]: ${s.content}\n`;
                    });
                } else if (session.settings.summary) {
                    systemContent += `【前情提要】\n${session.settings.summary}\n`;
                }

                // 4. 语境与时间 (注入计算结果)
                systemContent += `\n【当前语境】\n`;
                systemContent += `当前现实时间：${timeString}\n`;
                
                if (timeDiffMsg) {
                    if (longTimeNoSee) {
                        systemContent += `[Time Awareness: There has been a gap of ${timeDiffMsg}.]\n`;
                        if (isUserReplyDelay) {
                            // 用户让角色等了
                            systemContent += `[Context: The USER took ${timeDiffMsg} to reply to you. You were waiting. React to this delay based on your personality (e.g., "Where were you?", "Finally!", or indifferent).]\n`;
                        } else {
                            // 角色让用户等了
                            systemContent += `[Context: YOU (the character) have been silent for ${timeDiffMsg} and are now replying late. You might need to apologize or explain why you were away.]\n`;
                        }
                    } else {
                        systemContent += `距离上次回复：${timeDiffMsg} (Conversation is active)\n`;
                    }
                }

                // 5. 世界书
                if (session.settings.worldbookIds && session.settings.worldbookIds.length > 0) {
                    systemContent += `\n【世界书】\n`;
                    session.settings.worldbookIds.forEach(wbId => {
                        const wb = worldbooks.find(w => w.id === wbId);
                        if (wb) systemContent += `[${wb.name}]: ${replacePlaceholders(wb.content)}\n`;
                    });
                }

                // 6. 人设
                systemContent += `\n【用户设定】\n名字：${user.name}\n描述：${processedUserDesc}\n`;
                systemContent += `\n【角色设定】\n名字：${char.name}\n描述：${processedCharDesc}\n`;

                // 7. 破限
                systemContent += `\n【核心指令】\n${processedJailbreak}\n`;

                // 8. 强制心声输出
                systemContent += `\n[System Note: REQUIRED OUTPUT FORMAT]\n`;
                systemContent += `At the END of your response, you MUST output your internal state in Simplified Chinese using this JSON format:\n`;
                systemContent += `:::MIND_START:::{"status": "当前状态(中文)", "thoughts": "内心真实想法(中文,必填)", "wants": "想做的事(中文)"}:::MIND_END:::\n`;
                systemContent += `This block is hidden from the user. Ensure 'thoughts' accurately reflect your persona and the current context.\n`;

                const limit = parseInt(session.settings.memory) || 20;
                const rawHistory = session.messages.slice(-limit);
                const history = rawHistory.map(m => {
                    if (m.isRecalled) return { role: m.role, content: `[系统提示: ${m.role === 'user' ? '用户' : '你'}撤回了一条消息: "${m.originalContent}"]` };
                    
                    let contentPayload = m.content;
                    let prefix = m.quote ? `\n[Reference: ${m.quote.content}]\n` : "";

                    if (m.content.startsWith('ST_EMOJI:')) {
                        // 修复：增加安全检查，且只发送文字描述
                        const parts = m.content.split(':::');
                        const desc = parts.length > 0 ? parts[0].replace('ST_EMOJI:', '') : '未知表情';
                        // 修改：只发送文字描述给AI，不发图片URL，避免报错和节省Token
                        return { role: m.role, content: prefix + `[发送了一个表情包: ${desc}]` };
                    } else if (m.content.startsWith('ST_EMOJI_DESC:')) {
                        const desc = m.content.replace('ST_EMOJI_DESC:', '');
                        // 修改：只发送文字描述
                        return { role: m.role, content: prefix + `[发送了一个表情包: ${desc}]` };
                    } else if (m.content.startsWith('data:image')) {
                        return { role: m.role, content: [{ type: "text", text: prefix + `[发送了一张图片]` }, { type: "image_url", image_url: { url: m.content } }] };
                    } else if (m.content.startsWith('ST_VOICE:')) {
                        const parts = m.content.replace('ST_VOICE:', '').split(':::');
                        return { role: m.role, content: prefix + `[发送了一条语音消息：${parts[1] || ''}]` };
                    } else if (m.content.startsWith('ST_PHOTO_TEXT:')) {
                        return { role: m.role, content: prefix + `[发送了一张照片信息：${m.content.replace('ST_PHOTO_TEXT:', '')}]` };
                    } else if (m.content.startsWith('ST_TRANSFER:')) {
                        try {
                            const data = JSON.parse(m.content.replace('ST_TRANSFER:', ''));
                            const sender = m.role === 'user' ? '用户' : '你';
                            return { role: m.role, content: prefix + `[${sender}发送了一笔转账，金额：${data.amount}，备注：${data.remark}，状态：${data.status}]` };
                        } catch(e) { return { role: m.role, content: prefix + `[发送了一笔转账]` }; }
                    }
                    return { role: m.role, content: prefix + contentPayload };
                });

                const messagesPayload = [{ role: "system", content: systemContent }, ...history];

                let fetchUrl = '';
                const isGoogle = apiUrl.includes('googleapis.com');
                if (isGoogle) {
                    const baseUrl = apiUrl.endsWith('/') ? apiUrl.slice(0, -1) : apiUrl;
                    fetchUrl = baseUrl.includes('/models') ? `${baseUrl}?key=${apiKey}` : `${baseUrl}/chat/completions`;
                } else {
                    const baseUrl = apiUrl.endsWith('/') ? apiUrl.slice(0, -1) : apiUrl;
                    fetchUrl = baseUrl.endsWith('/v1') ? `${baseUrl}/chat/completions` : (baseUrl.endsWith('/chat/completions') ? baseUrl : `${baseUrl}/v1/chat/completions`);
                }

                const response = await fetch(fetchUrl, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: apiModel || 'gpt-3.5-turbo', messages: messagesPayload, temperature: 0.7 })
                });

                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const data = await response.json();

if (!data.choices || !data.choices[0] || !data.choices[0].message) throw new Error("API 返回格式异常");

let rawContent = data.choices[0].message.content || "";

// 检测并过滤掉 <think> 标签及其内容
// 如果你想把思考过程存入"心声"（点击头像查看），可以在这里提取，但目前我们先直接删除它以修复显示
rawContent = rawContent.replace(/<think>[\s\S]*?<\/think>/gi, "").trim();

// --- 解析心声数据 ---
const mindRegex = /:::MIND_START:::([\s\S]*?):::MIND_END:::/;
                const mindMatch = rawContent.match(mindRegex);
                
                if (mindMatch) {
                    try {
                        const mindJson = JSON.parse(mindMatch[1]);
                        session.currentMind = {
                            status: mindJson.status || (session.currentMind ? session.currentMind.status : '未知'),
                            thoughts: mindJson.thoughts || '...',
                            wants: mindJson.wants || (session.currentMind ? session.currentMind.wants : '未知')
                        };
                    } catch (e) {
                        console.error("心声解析失败", e);
                    }
                    rawContent = rawContent.replace(mindRegex, '').trim();
                }

                // --- 消息分块处理 ---
                const messageBlocks = rawContent.split('|||');

                for (let block of messageBlocks) {
                    block = block.trim();
                    if (!block) continue;

                    if (block === '[RECALL]') {
                        for (let i = session.messages.length - 1; i >= 0; i--) {
                            if (session.messages[i].role === 'assistant' && !session.messages[i].isRecalled) {
                                session.messages[i].isRecalled = true;
                                session.messages[i].originalContent = session.messages[i].content;
                                session.messages[i].content = "RECALLED";
                                break;
                            }
                        }
                        saveToDB('chatSessions', chatSessions);
                        renderMessages(session.messages);
                        renderChatList();
                        await new Promise(r => setTimeout(r, 800));
                        continue;
                    }

                    if (block === '[TRANSFER:ACCEPT]') {
                        const transferMsgIndex = session.messages.findIndex(m => m.role === 'user' && m.content.startsWith('ST_TRANSFER') && m.content.includes('"status":"pending"'));
                        if (transferMsgIndex !== -1) {
                            const tData = JSON.parse(session.messages[transferMsgIndex].content.replace('ST_TRANSFER:', ''));
                            tData.status = 'received'; tData.remark = '已被接收'; tData.actionTime = Date.now();
                            session.messages[transferMsgIndex].content = `ST_TRANSFER:${JSON.stringify(tData)}`;
                            const receiptData = { amount: tData.amount, remark: '已接收', status: 'received', timestamp: Date.now(), actionTime: Date.now(), originalTimestamp: tData.timestamp };
                            session.messages.push({ role: 'assistant', content: `ST_TRANSFER:${JSON.stringify(receiptData)}`, timestamp: Date.now() });
                            session.lastMessage = '[转账]'; session.timestamp = Date.now();
                            saveToDB('chatSessions', chatSessions); renderMessages(session.messages); renderChatList(); await new Promise(r => setTimeout(r, 800));
                        }
                        continue;
                    }

                    if (block === '[TRANSFER:RETURN]') {
                        const transferMsgIndex = session.messages.findIndex(m => m.role === 'user' && m.content.startsWith('ST_TRANSFER') && m.content.includes('"status":"pending"'));
                        if (transferMsgIndex !== -1) {
                            const tData = JSON.parse(session.messages[transferMsgIndex].content.replace('ST_TRANSFER:', ''));
                            tData.status = 'returned'; tData.remark = '已被退还'; tData.actionTime = Date.now();
                            session.messages[transferMsgIndex].content = `ST_TRANSFER:${JSON.stringify(tData)}`;
                            const returnData = { amount: tData.amount, remark: '已退还', status: 'returned', timestamp: Date.now(), actionTime: Date.now(), originalTimestamp: tData.timestamp };
                            session.messages.push({ role: 'assistant', content: `ST_TRANSFER:${JSON.stringify(returnData)}`, timestamp: Date.now() });
                            session.lastMessage = '[转账]'; session.timestamp = Date.now();
                            saveToDB('chatSessions', chatSessions); renderMessages(session.messages); renderChatList(); await new Promise(r => setTimeout(r, 800));
                        }
                        continue;
                    }

                    if (block.startsWith('[TRANSFER:')) {
                        const match = block.match(/\[TRANSFER:(\d+(\.\d+)?):(.*?)]/);
                        if (match) {
                            const transferData = { amount: parseFloat(match[1]).toFixed(2), remark: match[3].trim(), status: 'pending', timestamp: Date.now(), actionTime: null };
                            session.messages.push({ role: 'assistant', content: `ST_TRANSFER:${JSON.stringify(transferData)}`, timestamp: Date.now() });
                            session.lastMessage = '[转账]'; session.timestamp = Date.now();
                            saveToDB('chatSessions', chatSessions); renderMessages(session.messages); renderChatList(); await new Promise(r => setTimeout(r, 800));
                        }
                        continue;
                    }

                    if (block.startsWith('[VOICE:')) {
                        const match = block.match(/\[VOICE:(.*?)\]/);
                        if (match) {
                            const text = match[1].trim();
                            const duration = Math.max(2, Math.min(60, Math.ceil(text.length * 0.4)));
                            session.messages.push({ role: 'assistant', content: `ST_VOICE:${duration}:::${text}`, timestamp: Date.now() });
                            session.lastMessage = '[语音]'; session.timestamp = Date.now();
                            saveToDB('chatSessions', chatSessions); renderMessages(session.messages); renderChatList(); await new Promise(r => setTimeout(r, 800));
                        }
                        continue;
                    }

                    if (block.startsWith('[PHOTO:')) {
                        const match = block.match(/\[PHOTO:(.*?)\]/);
                        if (match) {
                            session.messages.push({ role: 'assistant', content: `ST_PHOTO_TEXT:${match[1].trim()}`, timestamp: Date.now() });
                            session.lastMessage = '[照片]'; session.timestamp = Date.now();
                            saveToDB('chatSessions', chatSessions); renderMessages(session.messages); renderChatList(); await new Promise(r => setTimeout(r, 800));
                        }
                        continue;
                    }

                    if (block.startsWith('[EMOJI:')) {
                        const match = block.match(/\[EMOJI:(.*?)\]/);
                        if (match) {
                            const desc = match[1].trim();
                            const found = customEmojis.find(e => e.desc === desc);
                            if (found) {
                                session.messages.push({ role: 'assistant', content: `ST_EMOJI_DESC:${desc}`, timestamp: Date.now() });
                                session.lastMessage = '[表情包]'; session.timestamp = Date.now();
                                saveToDB('chatSessions', chatSessions); renderMessages(session.messages); renderChatList(); await new Promise(r => setTimeout(r, 800));
                            }
                        }
                        continue;
                    }

                    if (block) {
                        const msgObj = { role: 'assistant', content: block, timestamp: Date.now() };
                        session.messages.push(msgObj);
                        session.lastMessage = block;
                        session.timestamp = Date.now();
                        saveToDB('chatSessions', chatSessions);
                        renderMessages(session.messages);
                        renderChatList();
                        await new Promise(r => setTimeout(r, 800));
                    }
                }

            } catch (error) {
                console.error(error);
                alert("回复失败: " + error.message);
            } finally {
                chatTitle.innerText = originalTitle;
            }
        }

        function closeChatInterface() {
            document.getElementById('chat-interface-page').classList.remove('active');
            
            // 重置编辑状态
            isEditingMessage = false;
            editingMessageIndex = -1;
            document.getElementById('chat-input-box').value = '';
            document.getElementById('chat-input-box').style.border = "none";
            
            renderChatList();
        }

        // --- 输入框双击展开逻辑 ---
        function toggleInputExpand() {
            const input = document.getElementById('chat-input-box');
            input.classList.toggle('expanded');
            // 如果展开了，聚焦
            if (input.classList.contains('expanded')) {
                input.focus();
            }
        }

        // --- 聊天列表逻辑 (左滑置顶/删除) ---
        function renderChatList() {
            const container = document.getElementById('chat-list-container');
            container.innerHTML = '';

            if (chatSessions.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #555; margin-top: 50px;">暂无会话</div>';
                return;
            }

            const sortedSessions = [...chatSessions].sort((a, b) => {
                if (a.pinned && !b.pinned) return -1;
                if (!a.pinned && b.pinned) return 1;
                return b.timestamp - a.timestamp;
            });

            sortedSessions.forEach(session => {
                const char = dataStore.character[session.charIndex];
                if (!char) return; 

                const wrapper = document.createElement('div');
                wrapper.className = 'list-item-wrapper';
                
                const actions = document.createElement('div');
                actions.className = 'list-item-actions';
                
                const pinBtn = document.createElement('button');
                pinBtn.className = 'action-btn btn-pin';
                pinBtn.innerText = session.pinned ? '取消' : '置顶';
                pinBtn.onclick = () => togglePinSession(session.id);

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'action-btn btn-delete';
                deleteBtn.innerText = '删除';
                deleteBtn.onclick = () => deleteSession(session.id);

                actions.appendChild(pinBtn);
                actions.appendChild(deleteBtn);

                const content = document.createElement('div');
                content.className = 'list-item';
                const displayName = session.settings && session.settings.remark ? session.settings.remark : char.name;
                
                content.innerHTML = `
                    <img src="${char.avatar || ''}" class="avatar" onerror="this.style.backgroundColor='var(--input-bg)'">
                    <div class="info">
                        <div class="info-name">${displayName} ${session.pinned ? '<span style="font-size:12px;color:var(--pin-color);">[置顶]</span>' : ''}</div>
                        <div class="info-desc" style="color:#aaa;">${session.lastMessage}</div>
                    </div>
                `;

                // 点击进入聊天
                content.onclick = (e) => {
                    // 如果正在滑动中，不触发点击
                    if (content.dataset.isSwiping === 'true') return;
                    // 如果处于展开状态，点击则是关闭
                    if (content.classList.contains('expanded')) {
                        content.style.transform = 'translateX(0)';
                        content.classList.remove('expanded');
                        return;
                    }
                    
                    currentChatSessionId = session.id;
                    document.getElementById('chat-title').innerText = displayName;
                    
                    // 修改：使用通用初始化函数，确保重置条数和绑定滚动事件
                    initializeChatInterface(session);
                };

                // --- 修复后的滑动逻辑 ---
                let touchStartX = 0;
                let currentTranslate = 0; // 记录当前的偏移量

                content.addEventListener('touchstart', (e) => {
                    touchStartX = e.changedTouches[0].screenX;
                    // 如果已经展开，起始偏移量就是 -140，否则是 0
                    currentTranslate = content.classList.contains('expanded') ? -140 : 0;
                    content.dataset.isSwiping = 'false'; // 重置滑动标记
                    
                    // 关闭其他已展开的项
                    document.querySelectorAll('#chat-list-container .list-item.expanded').forEach(el => {
                        if(el !== content) {
                            el.style.transform = 'translateX(0)';
                            el.classList.remove('expanded');
                        }
                    });
                }, {passive: true});

                content.addEventListener('touchmove', (e) => {
                    const touchX = e.changedTouches[0].screenX;
                    const diff = touchX - touchStartX;
                    
                    // 标记正在滑动
                    if (Math.abs(diff) > 5) content.dataset.isSwiping = 'true';

                    // 计算目标位置
                    let move = currentTranslate + diff;

                    // 限制滑动范围：0 (关闭) 到 -140 (完全展开)
                    if (move > 0) move = 0;     // 不能右滑超过起点
                    if (move < -140) move = -140; // 不能左滑超过按钮宽度

                    content.style.transform = `translateX(${move}px)`;
                    content.dataset.moveX = move; // 暂存当前位置供 touchend 使用
                }, {passive: true});

                content.addEventListener('touchend', (e) => {
                    const moveX = parseFloat(content.dataset.moveX || currentTranslate);
                    
                    // 阈值判断：如果滑动超过一半 (-70)，则吸附到展开状态，否则吸附到关闭状态
                    if (moveX < -70) {
                        content.style.transform = 'translateX(-140px)';
                        content.classList.add('expanded');
                    } else {
                        content.style.transform = 'translateX(0)';
                        content.classList.remove('expanded');
                    }
                    
                    // 清理
                    delete content.dataset.moveX;
                    // 延迟移除滑动标记，防止触发 click
                    setTimeout(() => { content.dataset.isSwiping = 'false'; }, 50);
                });

                wrapper.appendChild(actions);
                wrapper.appendChild(content);
                container.appendChild(wrapper);
            });
        }

        function togglePinSession(id) {
            const session = chatSessions.find(s => s.id === id);
            if (session) {
                session.pinned = !session.pinned;
                saveToDB('chatSessions', chatSessions);
                renderChatList();
            }
        }

        function deleteSession(id) {
            if(confirm('确定要删除这个会话吗？')) {
                chatSessions = chatSessions.filter(s => s.id !== id);
                saveToDB('chatSessions', chatSessions);
                renderChatList();
            } else {
                renderChatList();
            }
        }

        // --- 更多设置逻辑 (新增) ---
        function openChatMore() {
            const session = chatSessions.find(s => s.id === currentChatSessionId);
            if (!session) return; 

            if(!session.settings) session.settings = { memory: 20, summaries: [], remark: '', worldbookIds: [] };
            
            // 兼容旧数据：将 summary 字符串转为 summaries 数组
            if (session.settings.summary && (!session.settings.summaries || session.settings.summaries.length === 0)) {
                session.settings.summaries = [{
                    id: Date.now().toString(),
                    content: session.settings.summary,
                    timestamp: Date.now()
                }];
                session.settings.summary = ''; // 清空旧字段
                saveToDB('chatSessions', chatSessions);
            }
            if (!session.settings.summaries) session.settings.summaries = [];

            const char = dataStore.character[session.charIndex];
            const user = dataStore.user[session.userIndex];

            document.getElementById('more-char-avatar').src = char.avatar || '';
            document.getElementById('more-user-avatar').src = user.avatar || '';
            document.getElementById('more-char-name').innerText = char.name;
            document.getElementById('more-user-name').innerText = user.name;
            
                                    document.getElementById('more-remark').value = session.settings.remark || '';
            document.getElementById('more-memory').value = session.settings.memory || 20;
            
            // 新增：显示聊天总条数
            document.getElementById('more-total-count').value = session.messages ? session.messages.length : 0;

            // 加载自定义总结提示词
            document.getElementById('more-summary-prompt').value = session.settings.summaryPrompt || '';
            
            // 渲染总结列表
            renderSummaryList();

            // 更新世界书显示
            updateWorldbookInputDisplay(session.settings.worldbookIds);

            document.getElementById('chat-more-page').classList.add('active');
        }

        function renderSummaryList() {
            const container = document.getElementById('summary-list-container');
            container.innerHTML = '';
            const session = chatSessions.find(s => s.id === currentChatSessionId);
            if (!session || !session.settings.summaries || session.settings.summaries.length === 0) {
                container.innerHTML = '<div style="color:#666; font-size:12px; text-align:center; padding:10px;">暂无总结</div>';
                return;
            }

            session.settings.summaries.forEach((summary) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'list-item-wrapper';
                wrapper.style.marginBottom = '10px';
                wrapper.style.minHeight = '60px';

                const actions = document.createElement('div');
                actions.className = 'list-item-actions';
                
                const editBtn = document.createElement('button');
                editBtn.className = 'action-btn btn-edit';
                editBtn.innerText = '编辑';
                editBtn.onclick = () => openEditSummaryModal(summary.id);

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'action-btn btn-delete';
                deleteBtn.innerText = '删除';
                deleteBtn.onclick = () => deleteSummary(summary.id);

                actions.appendChild(editBtn);
                actions.appendChild(deleteBtn);

                const content = document.createElement('div');
                content.className = 'summary-content-wrapper';
                const dateStr = new Date(summary.timestamp).toLocaleString();
                
                // 显示范围提示 (如果存在)
                // 如果是第一条，范围通常是 1-endIndex
                // 如果是后续，范围是 prevEndIndex-endIndex
                // 但为了简化，我们直接读取 summary.content 里可能包含的范围信息，或者只显示生成时间
                // 这里我们选择在日期后面追加一个简单的标记
                let rangeInfo = "";
                if (summary.endIndex) {
                    // 尝试推算起始点：找到上一条总结的 endIndex
                    let prevEndIndex = 0;
                    const currentIndex = session.settings.summaries.indexOf(summary);
                    if (currentIndex > 0) {
                        prevEndIndex = session.settings.summaries[currentIndex - 1].endIndex || 0;
                    }
                    rangeInfo = ` (消息 ${prevEndIndex + 1}-${summary.endIndex})`;
                }

                content.innerHTML = `
                    <div class="summary-date">${dateStr}${rangeInfo}</div>
                    <div class="summary-text-preview">${summary.content}</div>
                `;

                content.onclick = (e) => {
                    if(Math.abs(sTouchEndX - sTouchStartX) > 10) return;
                    content.classList.toggle('expanded');
                };

                let sTouchStartX = 0;
                let sTouchEndX = 0;
                content.addEventListener('touchstart', (e) => {
                    sTouchStartX = e.changedTouches[0].screenX;
                    document.querySelectorAll('.summary-content-wrapper').forEach(el => {
                        if(el !== content) el.style.transform = 'translateX(0)';
                    });
                }, {passive: true});

                content.addEventListener('touchmove', (e) => {
                    sTouchEndX = e.changedTouches[0].screenX;
                    let diff = sTouchEndX - sTouchStartX;
                    if (diff < 0 && diff > -160) {
                        content.style.transform = `translateX(${diff}px)`;
                    }
                }, {passive: true});

                content.addEventListener('touchend', (e) => {
                    sTouchEndX = e.changedTouches[0].screenX;
                    let diff = sTouchEndX - sTouchStartX;
                    if (diff < -60) {
                        content.style.transform = 'translateX(-140px)';
                    } else {
                        content.style.transform = 'translateX(0)';
                    }
                    sTouchStartX = 0;
                    sTouchEndX = 0;
                });

                wrapper.appendChild(actions);
                wrapper.appendChild(content);
                container.appendChild(wrapper);
            });
        }

        function deleteSummary(id) {
            if(confirm('确定要删除这条总结吗？')) {
                const session = chatSessions.find(s => s.id === currentChatSessionId);
                session.settings.summaries = session.settings.summaries.filter(s => s.id !== id);
                saveToDB('chatSessions', chatSessions);
                renderSummaryList();
            } else {
                renderSummaryList();
            }
        }

        function openEditSummaryModal(id) {
            const session = chatSessions.find(s => s.id === currentChatSessionId);
            const summary = session.settings.summaries.find(s => s.id === id);
            if (!summary) return;

            editingSummaryId = id;
            document.getElementById('summary-edit-content').value = summary.content;
            document.getElementById('summary-edit-overlay').classList.add('show');
            renderSummaryList(); // 复位
        }

        function saveEditedSummary() {
            const session = chatSessions.find(s => s.id === currentChatSessionId);
            const summary = session.settings.summaries.find(s => s.id === editingSummaryId);
            const newContent = document.getElementById('summary-edit-content').value.trim();
            
            if (summary && newContent) {
                summary.content = newContent;
                saveToDB('chatSessions', chatSessions);
                renderSummaryList();
                document.getElementById('summary-edit-overlay').classList.remove('show');
            }
        }

        function updateWorldbookInputDisplay(ids) {
            if (!ids || ids.length === 0) {
                document.getElementById('more-worldbook').value = '';
                return;
            }
            const names = ids.map(id => {
                const wb = worldbooks.find(w => w.id === id);
                return wb ? wb.name : '';
            }).filter(n => n).join(', ');
            document.getElementById('more-worldbook').value = names;
        }

        function closeChatMore() {
            document.getElementById('chat-more-page').classList.remove('active');
            const session = chatSessions.find(s => s.id === currentChatSessionId);
            const char = dataStore.character[session.charIndex];
            const displayName = session.settings.remark ? session.settings.remark : char.name;
            document.getElementById('chat-title').innerText = displayName;
            renderMessages(session.messages);
        }

        function handleMoreAvatarChange(event, type) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64 = e.target.result;
                    const session = chatSessions.find(s => s.id === currentChatSessionId);
                    
                    if (type === 'char') {
                        dataStore.character[session.charIndex].avatar = base64;
                        document.getElementById('more-char-avatar').src = base64;
                    } else {
                        dataStore.user[session.userIndex].avatar = base64;
                        document.getElementById('more-user-avatar').src = base64;
                    }
                    saveToDB('dataStore', dataStore);
                };
                reader.readAsDataURL(file);
            }
        }

        function viewSettingDetails(type) {
            const session = chatSessions.find(s => s.id === currentChatSessionId);
            if (!session) return;

            let title = '';
            let content = '';

            if (type === 'char') {
                const char = dataStore.character[session.charIndex];
                title = char.name + ' 的设定';
                content = char.desc;
                        } else {
                const user = dataStore.user[session.userIndex];
                title = user.name + ' 的设定';
                content = user.desc;
            }

            document.getElementById('view-details-title').innerText = title;
            document.getElementById('view-details-content').innerText = content;
            document.getElementById('view-details-overlay').classList.add('show');
        }

        // --- 绑定世界书逻辑 (多选) ---
        function openWorldbookSelect() {
            const session = chatSessions.find(s => s.id === currentChatSessionId);
            if (!session) return;
            
            // 初始化临时选择状态
            tempSelectedWorldbooks = session.settings.worldbookIds ? [...session.settings.worldbookIds] : [];

            const container = document.getElementById('wb-select-list');
            container.innerHTML = '';

            if (worldbooks.length === 0) {
                container.innerHTML = '<div style="color:#888; text-align:center;">暂无世界书</div>';
            } else {
                worldbooks.forEach(wb => {
                    const item = document.createElement('div');
                    item.className = 'wb-select-item';
                    if (tempSelectedWorldbooks.includes(wb.id)) {
                        item.classList.add('selected');
                    }
                    item.innerText = wb.name;
                    item.onclick = () => toggleWorldbookSelection(item, wb.id);
                    container.appendChild(item);
                });
            }
            document.getElementById('wb-select-overlay').classList.add('show');
        }

        function toggleWorldbookSelection(element, id) {
            if (tempSelectedWorldbooks.includes(id)) {
                tempSelectedWorldbooks = tempSelectedWorldbooks.filter(i => i !== id);
                element.classList.remove('selected');
            } else {
                tempSelectedWorldbooks.push(id);
                element.classList.add('selected');
            }
        }

        function saveWorldbookSelection() {
            const session = chatSessions.find(s => s.id === currentChatSessionId);
            if (session) {
                session.settings.worldbookIds = [...tempSelectedWorldbooks];
                saveToDB('chatSessions', chatSessions);
                updateWorldbookInputDisplay(session.settings.worldbookIds);
            }
            document.getElementById('wb-select-overlay').classList.remove('show');
        }

        function saveMoreSettings() {
            const session = chatSessions.find(s => s.id === currentChatSessionId);
            if (session) {
                session.settings.remark = document.getElementById('more-remark').value;
                session.settings.memory = document.getElementById('more-memory').value;
                // 新增：保存自定义总结提示词
                session.settings.summaryPrompt = document.getElementById('more-summary-prompt').value;
                
                saveToDB('chatSessions', chatSessions);
            }
        }

        function clearChatHistory() {
            if(confirm('确定要清空所有聊天记录吗？')) {
                const session = chatSessions.find(s => s.id === currentChatSessionId);
                if (session) {
                    session.messages = [];
                    session.lastMessage = '';
                    saveToDB('chatSessions', chatSessions);
                    renderMessages([]);
                    alert('聊天记录已清空');
                }
            }
        }

        function exportChat() {
            const session = chatSessions.find(s => s.id === currentChatSessionId);
            if (!session) return;
            
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(session.messages));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "chat_history.json");
            document.body.appendChild(downloadAnchorNode); 
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function importChat(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const messages = JSON.parse(e.target.result);
                    if (Array.isArray(messages)) {
                        const session = chatSessions.find(s => s.id === currentChatSessionId);
                        session.messages = messages;
                        if (messages.length > 0) {
                            const last = messages[messages.length - 1];
                            session.lastMessage = last.content.startsWith('ST_') ? '[特殊消息]' : last.content;
                        }
                        saveToDB('chatSessions', chatSessions);
                        renderMessages(messages);
                        alert('导入成功');
                    } else {
                        alert('文件格式错误');
                    }
                } catch (err) {
                    alert('导入失败：' + err.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // --- 人物/用户设定 切换逻辑 ---
        
        function updateSettingsUI() {
            const title = document.getElementById('settings-title');
            if (currentTab === 'character') {
                title.innerText = '角色设定';
            } else {
                title.innerText = '用户设定';
            }
        }

        let settingsTouchStartX = 0;
        let isTouchOnItem = false;
        const settingsContentArea = document.getElementById('list-container');
        
        settingsContentArea.addEventListener('touchstart', (e) => {
            settingsTouchStartX = e.changedTouches[0].screenX;
            if (e.target.closest('.list-item-wrapper')) {
                isTouchOnItem = true;
            } else {
                isTouchOnItem = false;
            }
        }, {passive: true});

        settingsContentArea.addEventListener('touchend', (e) => {
            if (isTouchOnItem) return;
            let endX = e.changedTouches[0].screenX;
            let diff = endX - settingsTouchStartX;
            if (diff > 60) {
                toggleSettingsTab();
            }
        });

        function toggleSettingsTab() {
            if (currentTab === 'character') {
                currentTab = 'user';
            } else {
                currentTab = 'character';
            }
            updateSettingsUI();
            renderList();
        }

        // ==================== 人物设定列表逻辑 ====================
        function renderList() {
            const container = document.getElementById('list-container');
            container.innerHTML = '';
            const list = dataStore[currentTab];

            if (list.length === 0) {
                const emptyText = currentTab === 'character' ? '暂无角色，点击右上角加号添加' : '暂无用户，点击右上角加号添加';
                container.innerHTML = `<div style="text-align:center; color:#555; margin-top:50px;">${emptyText}</div>`;
                return;
            }

            list.forEach((item, index) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'list-item-wrapper';
                
                const actions = document.createElement('div');
                actions.className = 'list-item-actions';
                actions.innerHTML = `
                    <button class="action-btn btn-edit" onclick="openEditModal(${index})">编辑</button>
                    <button class="action-btn btn-delete" onclick="deleteItem(${index})">删除</button>
                `;

                const content = document.createElement('div');
                content.className = 'list-item';
                content.innerHTML = `
                    <img src="${item.avatar || ''}" class="avatar" onerror="this.style.backgroundColor='var(--input-bg)'">
                    <div class="info">
                        <div class="info-name">${item.name}</div>
                        <div class="info-desc">${item.desc}</div>
                    </div>
                `;

                content.onclick = (e) => {
                    if(Math.abs(touchEndX - touchStartX) > 10) return;
                    content.classList.toggle('expanded');
                };

                let touchStartX = 0;
                let touchEndX = 0;
                content.addEventListener('touchstart', (e) => {
                    touchStartX = e.changedTouches[0].screenX;
                    document.querySelectorAll('.list-item').forEach(el => {
                        if(el !== content) el.style.transform = 'translateX(0)';
                    });
                }, {passive: true});

                content.addEventListener('touchmove', (e) => {
                    touchEndX = e.changedTouches[0].screenX;
                    let diff = touchEndX - touchStartX;
                    if (diff < 0 && diff > -160) {
                        content.style.transform = `translateX(${diff}px)`;
                    }
                }, {passive: true});

                content.addEventListener('touchend', (e) => {
                    touchEndX = e.changedTouches[0].screenX;
                    let diff = touchEndX - touchStartX;
                    if (diff < -60) {
                        content.style.transform = 'translateX(-140px)';
                    } else {
                        content.style.transform = 'translateX(0)';
                    }
                    touchStartX = 0;
                    touchEndX = 0;
                });

                wrapper.appendChild(actions);
                wrapper.appendChild(content);
                container.appendChild(wrapper);
            });
        }

        // ==================== 弹窗与表单逻辑 ====================
        const modalOverlay = document.getElementById('modal-overlay');
        const modalTitle = document.getElementById('modal-title');
        const inputName = document.getElementById('input-name');
        const inputDesc = document.getElementById('input-desc');
        const avatarPreview = document.getElementById('avatar-preview');
        const avatarPlaceholder = document.getElementById('avatar-placeholder');
        const saveBtn = document.getElementById('btn-save');
        let currentAvatarBase64 = '';

        function openAddModal() {
            isEditing = false;
            editId = null;
            resetForm();
            modalTitle.innerText = currentTab === 'character' ? '添加角色设定' : '添加用户设定';
            modalOverlay.classList.add('show');
        }

        function openEditModal(index) {
            isEditing = true;
            editId = index;
            const item = dataStore[currentTab][index];
            inputName.value = item.name;
            inputDesc.value = item.desc;
            currentAvatarBase64 = item.avatar;
            if (currentAvatarBase64) {
                avatarPreview.src = currentAvatarBase64;
                avatarPreview.style.display = 'block';
                avatarPlaceholder.style.display = 'none';
            } else {
                avatarPreview.style.display = 'none';
                avatarPlaceholder.style.display = 'block';
            }
            modalTitle.innerText = '编辑设定';
            modalOverlay.classList.add('show');
            checkForm();
            renderList();
        }

        function closeModal() { modalOverlay.classList.remove('show'); }
        function handleOverlayClick(e) { if (e.target === modalOverlay) closeModal(); }

        function resetForm() {
            inputName.value = '';
            inputDesc.value = '';
            currentAvatarBase64 = '';
            avatarPreview.src = '';
            avatarPreview.style.display = 'none';
            avatarPlaceholder.style.display = 'block';
            document.getElementById('avatar-input').value = '';
            checkForm();
        }

        function checkForm() {
            if (inputName.value.trim() && inputDesc.value.trim() && currentAvatarBase64) {
                saveBtn.classList.add('active');
            } else {
                saveBtn.classList.remove('active');
            }
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentAvatarBase64 = e.target.result;
                    avatarPreview.src = currentAvatarBase64;
                    avatarPreview.style.display = 'block';
                    avatarPlaceholder.style.display = 'none';
                    checkForm();
                };
                reader.readAsDataURL(file);
            }
        }

        function saveData() {
            if (!document.getElementById('modal-overlay').classList.contains('show')) return;

            const newItem = {
                name: inputName.value.trim(),
                desc: inputDesc.value.trim(),
                avatar: currentAvatarBase64
            };
            if (isEditing) {
                dataStore[currentTab][editId] = newItem;
            } else {
                dataStore[currentTab].push(newItem);
            }
            
            saveToDB('dataStore', dataStore);
            closeModal();
            renderList();
        }

        function deleteItem(index) {
            if(confirm('确定要删除这条设定吗？')) {
                dataStore[currentTab].splice(index, 1);
                saveToDB('dataStore', dataStore);
                renderList();
            } else {
                renderList();
            }
        }

        // ==================== API 设置逻辑 ====================
        const apiUrlInput = document.getElementById('api-url');
        const apiKeyInput = document.getElementById('api-key');
        let apiModelInput = document.getElementById('api-model');
        const apiJailbreakInput = document.getElementById('api-jailbreak');

        async function pullModel() {
            const url = apiUrlInput.value.trim();
            const key = apiKeyInput.value.trim();

            if (!url || !key) {
                alert('请先填写API地址和密钥');
                return;
            }

            const btn = document.querySelector('.btn-pull');
            const originalText = btn.innerText;
            btn.innerText = '正在拉取...';
            btn.disabled = true;

            try {
                const isGoogle = url.includes('googleapis.com');
                let fetchUrl = '';
                let fetchOptions = {};

                if (isGoogle) {
                    const baseUrl = url.endsWith('/') ? url.slice(0, -1) : url;
                    if (baseUrl.includes('/models')) {
                        fetchUrl = `${baseUrl}?key=${key}`;
                    } else {
                        fetchUrl = `${baseUrl}/models?key=${key}`;
                    }
                    fetchOptions = { method: 'GET' };
                } else {
                    const baseUrl = url.endsWith('/') ? url.slice(0, -1) : url;
                    if (baseUrl.endsWith('/models')) {
                         fetchUrl = baseUrl;
                    } else {
                         fetchUrl = `${baseUrl}/models`;
                    }
                    fetchOptions = {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${key}`,
                            'Content-Type': 'application/json'
                        }
                    };
                }

                const response = await fetch(fetchUrl, fetchOptions);
                if (!response.ok) {
                    const errText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errText.slice(0, 100)}`);
                }

                const data = await response.json();
                let models = [];
                
                if (data.data && Array.isArray(data.data)) {
                    models = data.data.map(m => m.id);
                } else if (data.models && Array.isArray(data.models)) {
                    models = data.models.map(m => m.name.replace(/^models\//, ''));
                } else if (Array.isArray(data)) {
                    models = data.map(m => m.id || m);
                }

                if (models.length === 0) {
                    alert('未找到可用模型');
                    return;
                }

                models.sort();

                let currentInput = document.getElementById('api-model');
                const select = document.createElement('select');
                select.className = 'form-input';
                select.id = 'api-model';

                const def = document.createElement('option');
                def.text = '请选择模型';
                def.value = '';
                select.add(def);

                models.forEach(m => {
                    const opt = document.createElement('option');
                    opt.text = m;
                    opt.value = m;
                    select.add(opt);
                });

                currentInput.replaceWith(select);
                apiModelInput = select;
                
                alert(`成功拉取 ${models.length} 个模型`);

            } catch (error) {
                console.error('Fetch error:', error);
                let msg = '拉取模型失败: ' + error.message;
                if (error.message.includes('Failed to fetch')) {
                    msg += '\n\n【常见原因】\n1. 跨域限制(CORS)：浏览器拦截了请求。\n2. 地址错误：请检查API地址。\n3. 网络问题：无法连接到服务器。';
                }
                alert(msg);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        function resetModelInput(value = '') {
            let currentInput = document.getElementById('api-model');
            if (currentInput.tagName === 'SELECT') {
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'form-input';
                input.id = 'api-model';
                currentInput.replaceWith(input);
                apiModelInput = input;
            }
            apiModelInput.value = value;
        }

        function saveApiConfig() {
            apiModelInput = document.getElementById('api-model');
            
            const config = {
                url: apiUrlInput.value,
                key: apiKeyInput.value,
                model: apiModelInput.value,
                jailbreak: apiJailbreakInput.value
            };
            
            if(!config.url || !config.key) {
                alert('请填写完整的API信息');
                return;
            }

            saveToDB('currentApiConfig', config);
            alert('配置已保存并生效');
        }

        function addApiPreset() {
            apiModelInput = document.getElementById('api-model');
            
            const url = apiUrlInput.value;
            const key = apiKeyInput.value;
            const model = apiModelInput.value;
            const jailbreak = apiJailbreakInput.value;

            if(!url || !key) {
                alert('请先填写API地址和密钥');
                return;
            }

            const presetName = prompt("为该配置起一个名称：", "默认配置 " + (apiPresets.length + 1));
            if(presetName) {
                apiPresets.push({
                    name: presetName,
                    url: url,
                    key: key,
                    model: model,
                    jailbreak: jailbreak
                });
                
                saveToDB('apiPresets', apiPresets);
                renderPresets();
                alert('预设已添加');
            }
        }

        function deletePreset(index) {
            if(confirm('确定要删除这个预设吗？')) {
                apiPresets.splice(index, 1);
                saveToDB('apiPresets', apiPresets);
                renderPresets();
            } else {
                renderPresets(); 
            }
        }

        function renderPresets() {
            const container = document.getElementById('preset-list');
            container.innerHTML = '';

            if(apiPresets.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #555; padding: 20px;">暂无预设</div>';
                return;
            }

            apiPresets.forEach((preset, index) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'preset-wrapper';

                const deleteBtn = document.createElement('div');
                deleteBtn.className = 'preset-delete-btn';
                deleteBtn.innerText = '删除';
                deleteBtn.onclick = () => deletePreset(index);

                const item = document.createElement('div');
                item.className = 'preset-item';
                item.innerHTML = `
                    <div class="preset-info">
                        <div class="preset-name">${preset.name}</div>
                        <div class="preset-url">${preset.model || '未指定模型'}</div>
                    </div>
                    <div class="preset-select-icon">选择</div>
                `;

                item.onclick = () => {
                    if(Math.abs(touchEndX - touchStartX) > 10) return;
                    loadPreset(index);
                };

                let touchStartX = 0;
                let touchEndX = 0;
                
                item.addEventListener('touchstart', (e) => {
                    touchStartX = e.changedTouches[0].screenX;
                    document.querySelectorAll('.preset-item').forEach(el => {
                        if(el !== item) el.style.transform = 'translateX(0)';
                    });
                }, {passive: true});

                item.addEventListener('touchmove', (e) => {
                    touchEndX = e.changedTouches[0].screenX;
                    let diff = touchEndX - touchStartX;
                    if (diff < 0 && diff > -100) {
                        item.style.transform = `translateX(${diff}px)`;
                    }
                }, {passive: true});

                item.addEventListener('touchend', (e) => {
                    touchEndX = e.changedTouches[0].screenX;
                    let diff = touchEndX - touchStartX;
                    if (diff < -40) {
                        item.style.transform = 'translateX(-80px)';
                    } else {
                        item.style.transform = 'translateX(0)';
                    }
                    touchStartX = 0;
                    touchEndX = 0;
                });

                wrapper.appendChild(deleteBtn);
                wrapper.appendChild(item);
                container.appendChild(wrapper);
            });
        }

        function loadPreset(index) {
            const preset = apiPresets[index];
            apiUrlInput.value = preset.url;
            apiKeyInput.value = preset.key;
            
            resetModelInput(preset.model);
            
            apiJailbreakInput.value = preset.jailbreak || '';
            alert(`已加载预设：${preset.name}`);
        }

        // ==================== 新增主设置功能 ====================

        // 1. 调整顶部栏位置
        function adjustNavPosition(val) {
            document.documentElement.style.setProperty('--nav-top-padding', val + 'px');
            localStorage.setItem('miyo_nav_pos', val);
        }

        // 2. 修改聊天背景 (支持多模式)
        function handleBgUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64 = e.target.result;
                    document.documentElement.style.setProperty('--chat-bg-image', `url(${base64})`);
                    saveToDB('chatBackground' + getKeySuffix(), base64);
                    alert("聊天背景已更新，进入聊天界面即可查看。"); // 新增提示
                };
                reader.readAsDataURL(file);
            }
            event.target.value = '';
        }

        function resetChatBg() {
            document.documentElement.style.setProperty('--chat-bg-image', 'none');
            saveToDB('chatBackground' + getKeySuffix(), null); // 动态Key
        }

        // 3. 自定义气泡 CSS (支持多模式)
        function saveCustomCSS() {
            const css = document.getElementById('custom-css-input').value;
            document.getElementById('custom-bubble-style').innerHTML = css;
            localStorage.setItem('miyo_custom_css' + getKeySuffix(), css);
            // alert('样式已应用到当前模式'); // 移除弹窗，因为有实时预览了
        }

        // 4. 导出所有数据 (包含双模式数据)
        async function exportAllData() {
            const exportObj = {};
            // 从 Dexie 获取所有数据
            exportObj.dataStore = await loadFromDB('dataStore');
            exportObj.chatSessions = await loadFromDB('chatSessions');
            exportObj.apiPresets = await loadFromDB('apiPresets');
            exportObj.worldbooks = await loadFromDB('worldbooks');
            exportObj.customEmojis = await loadFromDB('customEmojis');
            exportObj.currentApiConfig = await loadFromDB('currentApiConfig');
            
            // 导出资源 (夜间)
            exportObj.chatBackground = await loadFromDB('chatBackground');
            exportObj.desktopBackground = await loadFromDB('desktopBackground');
            exportObj.desktopIcons = await loadFromDB('desktopIcons');
            
            // 导出资源 (日间)
            exportObj.chatBackground_light = await loadFromDB('chatBackground_light');
            exportObj.desktopBackground_light = await loadFromDB('desktopBackground_light');
            exportObj.desktopIcons_light = await loadFromDB('desktopIcons_light');

            // 导出 LocalStorage 关键配置
            exportObj.localStorage = {
                miyo_nav_pos: localStorage.getItem('miyo_nav_pos'),
                miyo_custom_css: localStorage.getItem('miyo_custom_css'),         // 夜间CSS
                miyo_custom_css_light: localStorage.getItem('miyo_custom_css_light'), // 日间CSS
                miyo_welcome_shown: localStorage.getItem('miyo_welcome_shown'),
                miyo_theme: localStorage.getItem('miyo_theme')
            };

            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportObj));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "Miyo_Full_Backup.json");
            document.body.appendChild(downloadAnchorNode); 
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        // 5. 导入所有数据
        function importAllData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if(!confirm("导入数据将覆盖当前所有设置和聊天记录，确定继续吗？")) {
                event.target.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // 恢复 DB 数据 (通用)
                    if (data.dataStore) await saveToDB('dataStore', data.dataStore);
                    if (data.chatSessions) await saveToDB('chatSessions', data.chatSessions);
                    if (data.apiPresets) await saveToDB('apiPresets', data.apiPresets);
                    if (data.worldbooks) await saveToDB('worldbooks', data.worldbooks);
                    if (data.customEmojis) await saveToDB('customEmojis', data.customEmojis);
                    if (data.currentApiConfig) await saveToDB('currentApiConfig', data.currentApiConfig);

                    // 恢复资源 (夜间)
                    if (data.chatBackground !== undefined) await saveToDB('chatBackground', data.chatBackground);
                    if (data.desktopBackground !== undefined) await saveToDB('desktopBackground', data.desktopBackground);
                    if (data.desktopIcons !== undefined) await saveToDB('desktopIcons', data.desktopIcons);

                    // 恢复资源 (日间)
                    if (data.chatBackground_light !== undefined) await saveToDB('chatBackground_light', data.chatBackground_light);
                    if (data.desktopBackground_light !== undefined) await saveToDB('desktopBackground_light', data.desktopBackground_light);
                    if (data.desktopIcons_light !== undefined) await saveToDB('desktopIcons_light', data.desktopIcons_light);

                    // 恢复 LocalStorage
                    if (data.localStorage) {
                        if (data.localStorage.miyo_nav_pos) localStorage.setItem('miyo_nav_pos', data.localStorage.miyo_nav_pos);
                        if (data.localStorage.miyo_custom_css) localStorage.setItem('miyo_custom_css', data.localStorage.miyo_custom_css);
                        if (data.localStorage.miyo_custom_css_light) localStorage.setItem('miyo_custom_css_light', data.localStorage.miyo_custom_css_light);
                        if (data.localStorage.miyo_welcome_shown) localStorage.setItem('miyo_welcome_shown', data.localStorage.miyo_welcome_shown);
                        if (data.localStorage.miyo_theme) localStorage.setItem('miyo_theme', data.localStorage.miyo_theme);
                    }

                    alert('数据恢复成功，即将刷新页面');
                    location.reload();
                } catch (err) {
                    alert('导入失败：' + err.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // ==================== 新增：角色心声弹窗逻辑 ====================
        function showCharacterMind() {
            const session = chatSessions.find(s => s.id === currentChatSessionId);
            if (!session) return;

            const char = dataStore.character[session.charIndex];
            
            // 填充基本信息
            document.getElementById('mind-avatar').src = char.avatar || '';
            document.getElementById('mind-name').innerText = char.name;

            // 获取心声数据 (如果不存在则显示默认值)
            const mind = session.currentMind || {
                status: '暂无状态',
                thoughts: '（角色尚未生成心声，请进行一次对话）',
                wants: '暂无'
            };

            document.getElementById('mind-status').innerText = mind.status;
            document.getElementById('mind-thoughts').innerText = mind.thoughts;
            document.getElementById('mind-wants').innerText = mind.wants;

            document.getElementById('mind-modal-overlay').classList.add('show');
        }

        // ==================== 新增：桌面时钟与背景图标逻辑 ====================

        // 1. 时钟逻辑
        function startClock() {
            function update() {
                const now = new Date();
                const hours = now.getHours().toString().padStart(2, '0');
                const minutes = now.getMinutes().toString().padStart(2, '0');
                document.getElementById('clock-time').innerText = `${hours}:${minutes}`;
                
                const month = now.getMonth() + 1;
                const date = now.getDate();
                const days = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];
                const day = days[now.getDay()];
                document.getElementById('clock-date').innerText = `${month}月${date}日 ${day}`;
            }
            update();
            setInterval(update, 1000);
        }

        // 2. 桌面背景逻辑 (支持多模式)
        function handleDesktopBgUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64 = e.target.result;
                    document.documentElement.style.setProperty('--desktop-bg-image', `url(${base64})`);
                    saveToDB('desktopBackground' + getKeySuffix(), base64);
                    alert("桌面背景已更新，请返回主界面查看。"); // 新增提示
                };
                reader.readAsDataURL(file);
            }
            event.target.value = '';
        }

        function resetDesktopBg() {
            document.documentElement.style.setProperty('--desktop-bg-image', 'none');
            saveToDB('desktopBackground' + getKeySuffix(), null); // 动态Key
        }

        // 3. 桌面图标逻辑 (支持多模式)
        function handleIconUpload(event) {
            const file = event.target.files[0];
            const type = document.getElementById('icon-select').value;
            
            if (file && type) {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const base64 = e.target.result;
                    
                    // 更新 UI (这里其实在主设置里看不到效果，因为图标在主页)
                    // const el = document.getElementById(`icon-${type}`); 
                    // if (el) el.style.backgroundImage = `url(${base64})`;

                    // 保存数据
                    const dbKey = 'desktopIcons' + getKeySuffix();
                    let icons = await loadFromDB(dbKey) || {};
                    icons[type] = base64;
                    saveToDB(dbKey, icons);
                    
                    alert("桌面图标已更新，请返回主界面查看。"); // 新增提示
                };
                reader.readAsDataURL(file);
            }
            event.target.value = '';
        }

        async function resetSelectedIcon() {
            const type = document.getElementById('icon-select').value;
            if (!type) return;

            // 更新 UI
            const el = document.getElementById(`icon-${type}`);
            if (el) el.style.backgroundImage = 'none';

            // 保存数据 (动态Key)
            const dbKey = 'desktopIcons' + getKeySuffix();
            let icons = await loadFromDB(dbKey) || {};
            delete icons[type];
            saveToDB(dbKey, icons);
        }

        // ==================== 新增：日间/夜间模式逻辑 ====================

        // 获取当前模式下的存储键名后缀
        function getKeySuffix() {
            return currentTheme === 'light' ? '_light' : '';
        }

        // 应用主题到 DOM
        function applyThemeToDOM() {
            document.documentElement.setAttribute('data-theme', currentTheme);
            const btn = document.getElementById('theme-toggle-btn');
            if (btn) btn.innerText = currentTheme === 'light' ? "切换为夜间模式" : "切换为日间模式";
        }

        // 切换主题
        async function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            localStorage.setItem('miyo_theme', currentTheme);
            
            applyThemeToDOM();
            await loadThemeResources(); // 重新加载该模式下的资源
            
            // 修复：切换后立即更新 CSS 输入框内容
            const cssInput = document.getElementById('custom-css-input');
            if (cssInput) {
                // 获取当前新模式下的 CSS
                const savedCSS = localStorage.getItem('miyo_custom_css' + getKeySuffix());
                // 如果有保存的CSS则填充，否则填充默认模板
                cssInput.value = savedCSS || `.chat-bubble {
    position: relative; 
    padding: 8px 12px; 
    border-radius: 8px; 
    font-size: 15px; 
    line-height: 1.5;
    word-wrap: break-word;
    max-width: 100%; 
    user-select: none; 
    -webkit-user-select: none;
    -webkit-touch-callout: none !important;
    -webkit-user-drag: none;
}`;
            }
        }

        // 加载当前主题的所有资源 (背景、图标、CSS)
        async function loadThemeResources() {
            const suffix = getKeySuffix();

            // 1. 聊天背景
            const savedBg = await loadFromDB('chatBackground' + suffix);
            document.documentElement.style.setProperty('--chat-bg-image', savedBg ? `url(${savedBg})` : 'none');

            // 2. 桌面背景
            const savedDesktopBg = await loadFromDB('desktopBackground' + suffix);
            document.documentElement.style.setProperty('--desktop-bg-image', savedDesktopBg ? `url(${savedDesktopBg})` : 'none');

            // 3. 桌面图标
            // 先重置为默认样式(防止残留)
            document.querySelectorAll('.desktop-icon').forEach(el => el.style.backgroundImage = 'none');
            
            const savedIcons = await loadFromDB('desktopIcons' + suffix) || {};
            for (const [key, base64] of Object.entries(savedIcons)) {
                const el = document.getElementById(`icon-${key}`);
                if (el && base64) {
                    el.style.backgroundImage = `url(${base64})`;
                }
            }

            // 4. 自定义气泡 CSS
            const savedCSS = localStorage.getItem('miyo_custom_css' + suffix);
            document.getElementById('custom-bubble-style').innerHTML = savedCSS || '';
        }

    </script>
</body>
</html>
